name: Build OnePlus Nord 3 AOSP - Zabixiiâš¡ (NetHunter)

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      BUILD_TIME:
        type: string
        description: "Custom build time (Enter F to use current time)"
        required: false
        default: "F"
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"
      KSU:
        type: boolean
        description: "Enable KernelSU/SukiSU? (false = Magisk only)"
        required: true
        default: false
      SUSFS_CI:
        type: choice
        description: "SUSFS module download method (only if KSU enabled)"
        required: true
        default: CI
        options:
          - CI
          - Release
          - NoN
      KSU_META:
        type: string
        description: "Branch name/Custom version identifier (only if KSU enabled)"
        required: false
        default: "susfs-main/Zabixii"
      FAST_BUILD:
        type: boolean
        description: "Enable fast build?"
        required: true
        default: true
      VFS:
        type: boolean
        description: "Enable manual hooks (VFS)? (only if KSU enabled)"
        required: true
        default: true
      KPM:
        type: boolean
        description: "Enable Kernel Patch Module (KPM)? (only if KSU enabled)"
        required: true
        default: true
      NETHUNTER:
        type: boolean
        description: "Enable NetHunter kernel support?"
        required: true
        default: true
      WIFI_DRIVERS:
        type: boolean
        description: "Include external Wi-Fi drivers? (RTL8812AU, ATH9K, etc.)"
        required: true
        default: true

jobs:
  notify_start:
    name: Notify Start
    runs-on: ubuntu-latest
    steps:
      - name: Get current time (IST)
        id: get_time
        run: echo "timestamp=$(TZ='Asia/Kolkata' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  build:
    needs: notify_start
    name: ${{ github.event.inputs.FAST_BUILD == 'true' && '[FAST]' || '' }}${{ github.event.inputs.KSU == 'true' && ' [KSU]' || ' [MAGISK]' }}${{ github.event.inputs.NETHUNTER == 'true' && ' [NH]' || '' }}${{ github.event.inputs.WIFI_DRIVERS == 'true' && ' [WIFI]' || '' }} ${{ github.event.inputs.SUFFIX }}
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Input Combinations
        run: |
          echo "Validating input combinations..."
          FILE="${{ github.event.inputs.FILE }}"
          declare -A VALID_COMBINATIONS=(
            ["manifest_aosp"]="mt6983 android12 5.10"
          )
          get_combination() {
            local key="$1"
            while true; do
              if [[ -n "${VALID_COMBINATIONS[$key]+_}" ]]; then
                echo "${VALID_COMBINATIONS[$key]}"
                return 0
              fi
              if [[ "$key" =~ ^(.+)_([a-z]+)$ ]]; then
                key="${BASH_REMATCH[1]}"
              else
                return 1
              fi
            done
          }
          COMBINATION="$(get_combination "$FILE")" || {
            echo "Unknown FILE: $FILE"
            exit 1
          }
          read CPU ANDROID_VERSION KERNEL_VERSION <<< "$COMBINATION"
          echo "Valid: FILE=$FILE, CPU=$CPU, ANDROID=$ANDROID_VERSION, KERNEL=$KERNEL_VERSION"
          echo "CPU=$CPU" >> $GITHUB_ENV
          echo "ANDROID_VERSION=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          if [[ "$ANDROID_VERSION" == "android12" && "$KERNEL_VERSION" == "5.10" ]]; then
            echo "BUILD_METHOD=perf" >> $GITHUB_ENV
          else
            echo "BUILD_METHOD=gki" >> $GITHUB_ENV
          fi

      - name: Check Disk Space
        run: df -h

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create and Enable 3G Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Set Cache Environment
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Configure Git
        run: |
          git config --global user.name "hemasai1109"
          git config --global user.email "pandunelluri.1109@gmail.com"

      - name: Configure APT Cache
        run: |
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR"/{archives,lists/partial}
          echo "Dir::Cache \"$APT_CACHE_DIR\";" | sudo tee /etc/apt/apt.conf.d/90user-cache
          echo "Dir::Cache::archives \"$APT_CACHE_DIR/archives\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Dir::State::lists \"$APT_CACHE_DIR/lists\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Check-Valid-Until \"false\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          echo "Acquire::Languages \"none\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
          sudo chown -R $USER:$USER "$APT_CACHE_DIR"

      - name: Set APT Cache
        uses: actions/cache@v3
        with:
          path: ${{ env.HOME }}/apt-cache
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/crom.yml') }}
          restore-keys: ${{ runner.os }}-apt-

      - name: Show Build Configuration
        run: |
          echo "=============================================="
          echo "  Zabixii Kernel Build Configuration"
          echo "=============================================="
          echo "CPU: ${{ env.CPU }}"
          echo "Android: ${{ env.ANDROID_VERSION }}"
          echo "Kernel: ${{ env.KERNEL_VERSION }}"
          echo "Build Method: ${{ env.BUILD_METHOD }}"
          echo "FILE: ${{ github.event.inputs.FILE }}"
          echo "SUFFIX: ${{ github.event.inputs.SUFFIX }}"
          echo "KSU: ${{ github.event.inputs.KSU }}"
          echo "NETHUNTER: ${{ github.event.inputs.NETHUNTER }}"
          echo "WIFI_DRIVERS: ${{ github.event.inputs.WIFI_DRIVERS }}"
          echo "FAST_BUILD: ${{ github.event.inputs.FAST_BUILD }}"
          if [ "${{ github.event.inputs.KSU }}" = "true" ]; then
            echo "VFS: ${{ github.event.inputs.VFS }}"
            echo "KPM: ${{ github.event.inputs.KPM }}"
          fi
          echo "=============================================="

      - name: Install Dependencies
        run: |
          sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
          APT_CACHE_DIR="$HOME/apt-cache"
          mkdir -p "$APT_CACHE_DIR/lists/partial"
          sudo apt -o Dir::Cache="$APT_CACHE_DIR" update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt -o Dir::Cache="$APT_CACHE_DIR" install -yq --no-install-recommends \
            python3 git curl ccache libelf-dev build-essential flex bison libssl-dev \
            libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip
          sudo apt install -y libelf-dev ccache llvm lld
          sudo apt update -qq

      - name: Restore Ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.event.inputs.FILE }}-${{ env.BUILD_METHOD }}-${{ github.event.inputs.FAST_BUILD == 'true' && 'fast' || 'normal' }}-17

      - name: Initialize Ccache
        run: |
          INIT_FLAG="${{ env.CCACHE_DIR }}/.ccache_initialized"
          if command -v ccache >/dev/null 2>&1; then
            if [ ! -f "$INIT_FLAG" ]; then
              mkdir -p "${{ env.CCACHE_DIR }}"
              ccache -M ${{ env.CCACHE_MAXSIZE }}
              touch "$INIT_FLAG"
            fi
          fi
          ccache -s

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Copy and Rename Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp -v kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983
          ls -ls build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory Structure
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          cd ..
          rm -rf kernel_module

      - name: Create Thermal Makefile
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          touch Makefile
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile

      - name: Create Fingerprint Makefile
        run: |
          cd kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          rm -f Makefile
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

      - name: Fix Audio Codec Conflict
        run: |
          cd kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c

      - name: Apply Custom Kernel Suffix
        if: ${{ github.event.inputs.SUFFIX != '' }}
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          FAST_BUILD="${{ github.event.inputs.FAST_BUILD }}"
          for path in kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion; do
            [ -f "$path" ] || continue
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"
            if grep -q 'echo "\$res"' "$path"; then
              if [ "$FAST_BUILD" = "true" ]; then
                sed -i "s/^res=.*/res=\"-${ANDROID_VERSION}-${SUFFIX}\"/" "$path"
              else
                tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp" && mv "$path.tmp" "$path"
              fi
            fi
            chmod +x "$path"
          done
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX"

      # ==========================================
      # KSU/SUKISU STEPS (ONLY IF KSU=true)
      # ==========================================
      - name: Add SukiSU Ultra
        if: ${{ github.event.inputs.KSU == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          META="${{ github.event.inputs.KSU_META }}"
          BRANCH_NAME="${META%%/*}"
          CUSTOM_TAG="${META#*/}"
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH_NAME"
          cd ./KernelSU
          KSU_API_VERSION=$(curl -fsSL "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/$BRANCH_NAME/kernel/Makefile" | \
            grep -m1 "KSU_VERSION_API :=" | awk -F'= ' '{print $2}' | tr -d '[:space:]')
          [[ -z "$KSU_API_VERSION" ]] && KSU_API_VERSION="3.1.7"
          echo "KSU_API_VERSION=$KSU_API_VERSION" >> $GITHUB_ENV
          KSU_VERSION_FULL="v$KSU_API_VERSION-$CUSTOM_TAG@$BRANCH_NAME"
          echo "KSU_VERSION_FULL=$KSU_VERSION_FULL" >> $GITHUB_ENV
          sed -i '/KSU_VERSION_API :=/d' kernel/Makefile
          sed -i '/KSU_VERSION_FULL :=/d' kernel/Makefile
          echo "KSU_VERSION_API := $KSU_API_VERSION" >> kernel/Makefile
          echo "KSU_VERSION_FULL := $KSU_VERSION_FULL" >> kernel/Makefile
          KSU_VERSION=$(expr $(git rev-list --count main 2>/dev/null || echo 13000) + 10700)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

      - name: Apply SUSFS Patches
        if: ${{ github.event.inputs.KSU == 'true' }}
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          cd kernel-5.10
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./
          cp ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true

      - name: Apply Hide Stuff Patches
        if: ${{ github.event.inputs.KSU == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cp ../SukiSU_patch/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch

      - name: Apply VFS Hooks
        if: ${{ github.event.inputs.KSU == 'true' && github.event.inputs.VFS == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cp ../SukiSU_patch/hooks/syscall_hooks.patch ./
          patch -p1 -F 3 < syscall_hooks.patch

      - name: Add KSU Configuration
        if: ${{ github.event.inputs.KSU == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          CONFIG_FILE=./arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU=y" >> "$CONFIG_FILE"
          if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
            echo "CONFIG_KPM=y" >> "$CONFIG_FILE"
          fi
          if [ "${{ github.event.inputs.VFS }}" = "true" ]; then
            echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> "$CONFIG_FILE"
            echo "CONFIG_KSU_MANUAL_HOOK=y" >> "$CONFIG_FILE"
          else
            echo "CONFIG_KSU_SUSFS_SUS_SU=y" >> "$CONFIG_FILE"
            echo "CONFIG_KPROBES=y" >> "$CONFIG_FILE"
          fi
          echo "CONFIG_KSU_SUSFS=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SUS_MAP=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> "$CONFIG_FILE"
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> "$CONFIG_FILE"

      # ==========================================
      # COMMON CONFIGS (BOTH KSU AND MAGISK)
      # ==========================================
      - name: Add Common Kernel Optimizations
        run: |
          cd kernel_workspace/kernel-5.10
          CONFIG_FILE=./arch/arm64/configs/gki_defconfig
          echo "" >> "$CONFIG_FILE"
          echo "# Common Optimizations" >> "$CONFIG_FILE"
          echo "CONFIG_TMPFS_XATTR=y" >> "$CONFIG_FILE"
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> "$CONFIG_FILE"
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> "$CONFIG_FILE"
          echo "CONFIG_TCP_CONG_BBR=y" >> "$CONFIG_FILE"
          echo "CONFIG_NET_SCH_FQ=y" >> "$CONFIG_FILE"
          echo "CONFIG_TCP_CONG_BIC=n" >> "$CONFIG_FILE"
          echo "CONFIG_TCP_CONG_WESTWOOD=n" >> "$CONFIG_FILE"
          echo "CONFIG_TCP_CONG_HTCP=n" >> "$CONFIG_FILE"
          echo "CONFIG_IP_ECN=y" >> "$CONFIG_FILE"
          echo "CONFIG_TCP_ECN=y" >> "$CONFIG_FILE"
          echo "CONFIG_IPV6_ECN=y" >> "$CONFIG_FILE"
          echo "CONFIG_IP_NF_TARGET_ECN=y" >> "$CONFIG_FILE"
          sed -i 's/check_defconfig//' ./build.config.gki

      # ==========================================
      # NETHUNTER CONFIGS
      # ==========================================
      - name: Add NetHunter Kernel Configuration
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          CONFIG_FILE=./arch/arm64/configs/gki_defconfig
          
          echo "=============================================="
          echo "  Adding NetHunter Kernel Configs"
          echo "=============================================="
          
          add_config() {
            local config="$1"
            local desc="$2"
            local name="${config%%=*}"
            
            if grep -q "^${name}=" "$CONFIG_FILE"; then
              echo "SKIP: $name already set"
            elif grep -q "^# ${name} is not set" "$CONFIG_FILE"; then
              sed -i "s/^# ${name} is not set/${config}/" "$CONFIG_FILE"
              echo "ENABLED: $name ($desc)"
            else
              echo "$config" >> "$CONFIG_FILE"
              echo "ADDED: $name ($desc)"
            fi
          }
          
          echo "" >> "$CONFIG_FILE"
          echo "# ===========================================" >> "$CONFIG_FILE"
          echo "# NETHUNTER SUPPORT" >> "$CONFIG_FILE"
          echo "# ===========================================" >> "$CONFIG_FILE"
          
          # IKCONFIG
          add_config "CONFIG_IKCONFIG=y" "Kernel config export"
          add_config "CONFIG_IKCONFIG_PROC=y" "Kernel config in /proc"
          
          # USB Gadget/HID
          add_config "CONFIG_USB_GADGET=y" "USB Gadget framework"
          add_config "CONFIG_USB_CONFIGFS=y" "USB ConfigFS"
          add_config "CONFIG_USB_CONFIGFS_F_HID=y" "HID function"
          add_config "CONFIG_USB_F_HID=y" "USB HID driver"
          add_config "CONFIG_USB_G_HID=y" "HID gadget"
          add_config "CONFIG_USB_CONFIGFS_SERIAL=y" "USB serial"
          add_config "CONFIG_USB_CONFIGFS_ACM=y" "USB ACM"
          add_config "CONFIG_USB_CONFIGFS_RNDIS=y" "USB RNDIS"
          add_config "CONFIG_USB_CONFIGFS_ECM=y" "USB ECM"
          add_config "CONFIG_USB_CONFIGFS_NCM=y" "USB NCM"
          add_config "CONFIG_USB_CONFIGFS_MASS_STORAGE=y" "USB mass storage"
          
          # USB Host/OTG
          add_config "CONFIG_USB=y" "USB support"
          add_config "CONFIG_USB_OTG=y" "USB OTG"
          add_config "CONFIG_USB_XHCI_HCD=y" "xHCI"
          add_config "CONFIG_USB_EHCI_HCD=y" "EHCI"
          add_config "CONFIG_USB_ACM=y" "USB ACM"
          add_config "CONFIG_USB_STORAGE=y" "USB storage"
          add_config "CONFIG_USB_UAS=y" "USB UAS"
          
          # USB Serial
          add_config "CONFIG_USB_SERIAL=y" "USB serial"
          add_config "CONFIG_USB_SERIAL_GENERIC=y" "Generic USB serial"
          add_config "CONFIG_USB_SERIAL_CH341=y" "CH341 serial"
          add_config "CONFIG_USB_SERIAL_CP210X=y" "CP210x serial"
          add_config "CONFIG_USB_SERIAL_FTDI_SIO=y" "FTDI serial"
          add_config "CONFIG_USB_SERIAL_PL2303=y" "PL2303 serial"
          add_config "CONFIG_USB_SERIAL_OPTION=y" "Option serial"
          
          # Wireless framework
          add_config "CONFIG_WIRELESS=y" "Wireless"
          add_config "CONFIG_WIRELESS_EXT=y" "Wireless extensions"
          add_config "CONFIG_WEXT_CORE=y" "WEXT core"
          add_config "CONFIG_WEXT_PROC=y" "WEXT proc"
          add_config "CONFIG_WEXT_PRIV=y" "WEXT priv"
          add_config "CONFIG_CFG80211=y" "cfg80211"
          add_config "CONFIG_CFG80211_WEXT=y" "cfg80211 WEXT"
          add_config "CONFIG_MAC80211=y" "mac80211"
          add_config "CONFIG_MAC80211_MESH=y" "mac80211 mesh"
          add_config "CONFIG_RFKILL=y" "RFKILL"
          add_config "CONFIG_RFKILL_INPUT=y" "RFKILL input"
          
          # Netfilter/iptables
          add_config "CONFIG_NETFILTER=y" "Netfilter"
          add_config "CONFIG_NETFILTER_ADVANCED=y" "Netfilter advanced"
          add_config "CONFIG_NF_CONNTRACK=y" "Connection tracking"
          add_config "CONFIG_NF_NAT=y" "NAT"
          add_config "CONFIG_NF_TABLES=y" "nftables"
          add_config "CONFIG_IP_NF_IPTABLES=y" "iptables"
          add_config "CONFIG_IP_NF_FILTER=y" "iptables filter"
          add_config "CONFIG_IP_NF_NAT=y" "iptables NAT"
          add_config "CONFIG_IP_NF_TARGET_MASQUERADE=y" "MASQUERADE"
          add_config "CONFIG_IP_NF_TARGET_REDIRECT=y" "REDIRECT"
          add_config "CONFIG_IP_NF_MANGLE=y" "Mangle table"
          add_config "CONFIG_IP_NF_RAW=y" "Raw table"
          add_config "CONFIG_IP6_NF_IPTABLES=y" "ip6tables"
          add_config "CONFIG_IP6_NF_FILTER=y" "ip6tables filter"
          add_config "CONFIG_IP6_NF_NAT=y" "ip6tables NAT"
          add_config "CONFIG_IP6_NF_TARGET_MASQUERADE=y" "ip6 MASQUERADE"
          add_config "CONFIG_NETFILTER_XT_TARGET_LOG=y" "LOG target"
          add_config "CONFIG_NETFILTER_XT_TARGET_NFLOG=y" "NFLOG target"
          add_config "CONFIG_NETFILTER_XT_TARGET_TPROXY=y" "TPROXY target"
          add_config "CONFIG_NETFILTER_XT_TARGET_REDIRECT=y" "REDIRECT target"
          add_config "CONFIG_NETFILTER_XT_TARGET_TEE=y" "TEE target"
          add_config "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" "addrtype match"
          add_config "CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y" "conntrack match"
          add_config "CONFIG_NETFILTER_XT_MATCH_HASHLIMIT=y" "hashlimit match"
          add_config "CONFIG_NETFILTER_XT_MATCH_IPRANGE=y" "iprange match"
          add_config "CONFIG_NETFILTER_XT_MATCH_LENGTH=y" "length match"
          add_config "CONFIG_NETFILTER_XT_MATCH_LIMIT=y" "limit match"
          add_config "CONFIG_NETFILTER_XT_MATCH_MAC=y" "mac match"
          add_config "CONFIG_NETFILTER_XT_MATCH_MARK=y" "mark match"
          add_config "CONFIG_NETFILTER_XT_MATCH_MULTIPORT=y" "multiport match"
          add_config "CONFIG_NETFILTER_XT_MATCH_OWNER=y" "owner match"
          add_config "CONFIG_NETFILTER_XT_MATCH_STATE=y" "state match"
          add_config "CONFIG_NETFILTER_XT_MATCH_STRING=y" "string match"
          add_config "CONFIG_NETFILTER_XT_MATCH_U32=y" "u32 match"
          
          # Namespaces (NO USER_NS - causes bootloop)
          add_config "CONFIG_NAMESPACES=y" "Namespaces"
          add_config "CONFIG_NET_NS=y" "Network namespaces"
          add_config "CONFIG_PID_NS=y" "PID namespaces"
          add_config "CONFIG_IPC_NS=y" "IPC namespaces"
          add_config "CONFIG_UTS_NS=y" "UTS namespaces"
          add_config "CONFIG_CGROUPS=y" "Control groups"
          
          # Bluetooth
          add_config "CONFIG_BT=y" "Bluetooth"
          add_config "CONFIG_BT_BREDR=y" "Bluetooth BR/EDR"
          add_config "CONFIG_BT_LE=y" "Bluetooth LE"
          add_config "CONFIG_BT_RFCOMM=y" "RFCOMM"
          add_config "CONFIG_BT_RFCOMM_TTY=y" "RFCOMM TTY"
          add_config "CONFIG_BT_BNEP=y" "BNEP"
          add_config "CONFIG_BT_HIDP=y" "HIDP"
          add_config "CONFIG_BT_HCIBTUSB=y" "HCI USB"
          add_config "CONFIG_BT_HCIUART=y" "HCI UART"
          
          # Input/HID
          add_config "CONFIG_INPUT=y" "Input"
          add_config "CONFIG_INPUT_EVDEV=y" "Event device"
          add_config "CONFIG_INPUT_UINPUT=y" "User input"
          add_config "CONFIG_INPUT_MISC=y" "Input misc"
          add_config "CONFIG_HID=y" "HID"
          add_config "CONFIG_HIDRAW=y" "HID raw"
          add_config "CONFIG_UHID=y" "User HID"
          add_config "CONFIG_USB_HID=y" "USB HID"
          
          # Networking
          add_config "CONFIG_NET=y" "Networking"
          add_config "CONFIG_PACKET=y" "Packet socket"
          add_config "CONFIG_UNIX=y" "Unix sockets"
          add_config "CONFIG_INET=y" "TCP/IP"
          add_config "CONFIG_IP_MULTICAST=y" "IP multicast"
          add_config "CONFIG_IP_ADVANCED_ROUTER=y" "Advanced router"
          add_config "CONFIG_IP_MULTIPLE_TABLES=y" "Multiple routing tables"
          add_config "CONFIG_NET_IPGRE=y" "GRE tunnels"
          add_config "CONFIG_SYN_COOKIES=y" "SYN cookies"
          add_config "CONFIG_TUN=y" "TUN/TAP"
          add_config "CONFIG_VETH=y" "Virtual ethernet"
          add_config "CONFIG_BRIDGE=y" "Ethernet bridge"
          add_config "CONFIG_VLAN_8021Q=y" "802.1Q VLAN"
          add_config "CONFIG_MACVLAN=y" "MAC VLAN"
          add_config "CONFIG_IPVLAN=y" "IP VLAN"
          add_config "CONFIG_DUMMY=y" "Dummy interface"
          
          # PPP/VPN
          add_config "CONFIG_PPP=y" "PPP"
          add_config "CONFIG_PPP_BSDCOMP=y" "PPP BSD comp"
          add_config "CONFIG_PPP_DEFLATE=y" "PPP deflate"
          add_config "CONFIG_PPP_MPPE=y" "PPP MPPE"
          add_config "CONFIG_PPPOE=y" "PPPoE"
          add_config "CONFIG_PPTP=y" "PPTP"
          add_config "CONFIG_PPPOL2TP=y" "L2TP"
          add_config "CONFIG_PPP_ASYNC=y" "PPP async"
          add_config "CONFIG_PPP_SYNC_TTY=y" "PPP sync TTY"
          
          # Crypto
          add_config "CONFIG_CRYPTO=y" "Crypto"
          add_config "CONFIG_CRYPTO_USER=y" "Crypto user"
          add_config "CONFIG_CRYPTO_USER_API=y" "Crypto user API"
          add_config "CONFIG_CRYPTO_USER_API_HASH=y" "Crypto hash API"
          add_config "CONFIG_CRYPTO_USER_API_SKCIPHER=y" "Crypto skcipher API"
          add_config "CONFIG_CRYPTO_AES=y" "AES"
          add_config "CONFIG_CRYPTO_SHA256=y" "SHA256"
          add_config "CONFIG_CRYPTO_SHA512=y" "SHA512"
          add_config "CONFIG_CRYPTO_GCM=y" "GCM"
          add_config "CONFIG_CRYPTO_CBC=y" "CBC"
          add_config "CONFIG_CRYPTO_HMAC=y" "HMAC"
          
          # Filesystems
          add_config "CONFIG_EXT4_FS=y" "ext4"
          add_config "CONFIG_EXT4_FS_POSIX_ACL=y" "ext4 ACL"
          add_config "CONFIG_EXT4_FS_SECURITY=y" "ext4 security"
          add_config "CONFIG_FUSE_FS=y" "FUSE"
          add_config "CONFIG_OVERLAY_FS=y" "OverlayFS"
          add_config "CONFIG_SQUASHFS=y" "SquashFS"
          add_config "CONFIG_SQUASHFS_XATTR=y" "SquashFS xattr"
          add_config "CONFIG_SQUASHFS_ZLIB=y" "SquashFS zlib"
          add_config "CONFIG_SQUASHFS_LZ4=y" "SquashFS lz4"
          add_config "CONFIG_SQUASHFS_LZO=y" "SquashFS lzo"
          add_config "CONFIG_SQUASHFS_XZ=y" "SquashFS xz"
          add_config "CONFIG_SQUASHFS_ZSTD=y" "SquashFS zstd"
          add_config "CONFIG_TMPFS=y" "tmpfs"
          add_config "CONFIG_TMPFS_POSIX_ACL=y" "tmpfs ACL"
          add_config "CONFIG_TMPFS_XATTR=y" "tmpfs xattr"
          add_config "CONFIG_CIFS=y" "CIFS"
          add_config "CONFIG_NFS_FS=y" "NFS"
          
          # Firmware loading
          add_config "CONFIG_FW_LOADER=y" "Firmware loader"
          add_config "CONFIG_FW_LOADER_USER_HELPER=y" "Firmware user helper"
          add_config "CONFIG_FW_LOADER_USER_HELPER_FALLBACK=y" "Firmware fallback"
          
          # Misc
          add_config "CONFIG_SECCOMP=y" "Seccomp"
          add_config "CONFIG_BINFMT_MISC=y" "Misc binaries"
          add_config "CONFIG_SYSVIPC=y" "System V IPC"
          add_config "CONFIG_POSIX_MQUEUE=y" "POSIX mqueue"
          add_config "CONFIG_MAGIC_SYSRQ=y" "Magic SysRq"
          add_config "CONFIG_DEBUG_FS=y" "DebugFS"
          
          echo ""
          echo "NetHunter configs added!"

      # ==========================================
      # WIFI DRIVERS
      # ==========================================
      - name: Add Wi-Fi Driver Configs (Mainline)
        if: ${{ github.event.inputs.WIFI_DRIVERS == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          CONFIG_FILE=./arch/arm64/configs/gki_defconfig
          
          echo "" >> "$CONFIG_FILE"
          echo "# WIFI DRIVERS (MAINLINE)" >> "$CONFIG_FILE"
          echo "CONFIG_ATH_COMMON=y" >> "$CONFIG_FILE"
          echo "CONFIG_ATH9K=y" >> "$CONFIG_FILE"
          echo "CONFIG_ATH9K_HTC=y" >> "$CONFIG_FILE"
          echo "CONFIG_ATH9K_HW=y" >> "$CONFIG_FILE"
          echo "CONFIG_ATH9K_COMMON=y" >> "$CONFIG_FILE"
          echo "CONFIG_RT2X00=y" >> "$CONFIG_FILE"
          echo "CONFIG_RT2800USB=y" >> "$CONFIG_FILE"
          echo "CONFIG_RT2800_LIB=y" >> "$CONFIG_FILE"
          echo "CONFIG_RT2X00_LIB_USB=y" >> "$CONFIG_FILE"
          echo "CONFIG_RT2X00_LIB=y" >> "$CONFIG_FILE"
          echo "CONFIG_MT7601U=y" >> "$CONFIG_FILE"
          echo "CONFIG_MT76_CORE=y" >> "$CONFIG_FILE"
          echo "CONFIG_MT76_USB=y" >> "$CONFIG_FILE"
          echo "CONFIG_MT76x0_COMMON=y" >> "$CONFIG_FILE"
          echo "CONFIG_MT76x0U=y" >> "$CONFIG_FILE"
          echo "CONFIG_MT76x2_COMMON=y" >> "$CONFIG_FILE"
          echo "CONFIG_MT76x2U=y" >> "$CONFIG_FILE"
          echo "CONFIG_RTL8XXXU=y" >> "$CONFIG_FILE"
          echo "CONFIG_RTL8192CU=y" >> "$CONFIG_FILE"
          echo "CONFIG_RTLWIFI=y" >> "$CONFIG_FILE"
          echo "CONFIG_RTLWIFI_USB=y" >> "$CONFIG_FILE"
          echo "CONFIG_ZD1211RW=y" >> "$CONFIG_FILE"

      - name: Clone External Wi-Fi Drivers (Out-of-tree)
        if: ${{ github.event.inputs.WIFI_DRIVERS == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10/drivers/net/wireless
          
          echo "Cloning RTL8812AU (aircrack-ng)..."
          git clone https://github.com/aircrack-ng/rtl8812au.git --depth=1 || true
          
          echo "Cloning RTL8814AU..."
          git clone https://github.com/aircrack-ng/rtl8814au.git --depth=1 || true
          
          echo "Cloning RTL8188EUS..."
          git clone https://github.com/aircrack-ng/rtl8188eus.git --depth=1 || true
          
          echo "Cloning RTL88x2BU..."
          git clone https://github.com/morrownr/88x2bu-20210702.git rtl88x2bu --depth=1 || true
          
          echo "External drivers cloned."

      - name: Fix External Wi-Fi Driver Kconfig Syntax
        if: ${{ github.event.inputs.WIFI_DRIVERS == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10/drivers/net/wireless
          
          echo "Fixing Kconfig syntax..."
          
          # Fix ---help--- to help (deprecated in newer kernels)
          find . -name "Kconfig" -type f -exec sed -i 's/---help---/help/g' {} \;
          
          # Fix trailing whitespace
          find . -name "Kconfig" -type f -exec sed -i 's/[[:space:]]*$//' {} \;
          
          # Ensure newline at end of file
          find . -name "Kconfig" -type f -exec sh -c 'tail -c1 "$1" | read -r _ || echo >> "$1"' _ {} \;
          
          echo "Kconfig syntax fixed."

      - name: Integrate External Wi-Fi Drivers
        if: ${{ github.event.inputs.WIFI_DRIVERS == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10/drivers/net/wireless
          
          # Update Kconfig
          if ! grep -q "rtl8812au" Kconfig 2>/dev/null; then
            echo 'source "drivers/net/wireless/rtl8812au/Kconfig"' >> Kconfig
          fi
          if ! grep -q "rtl8814au" Kconfig 2>/dev/null; then
            echo 'source "drivers/net/wireless/rtl8814au/Kconfig"' >> Kconfig
          fi
          if ! grep -q "rtl8188eus" Kconfig 2>/dev/null; then
            echo 'source "drivers/net/wireless/rtl8188eus/Kconfig"' >> Kconfig
          fi
          if ! grep -q "rtl88x2bu" Kconfig 2>/dev/null; then
            echo 'source "drivers/net/wireless/rtl88x2bu/Kconfig"' >> Kconfig
          fi
          
          # Update Makefile
          if ! grep -q "rtl8812au" Makefile 2>/dev/null; then
            echo 'obj-$(CONFIG_88XXAU) += rtl8812au/' >> Makefile
          fi
          if ! grep -q "rtl8814au" Makefile 2>/dev/null; then
            echo 'obj-$(CONFIG_RTL8814AU) += rtl8814au/' >> Makefile
          fi
          if ! grep -q "rtl8188eus" Makefile 2>/dev/null; then
            echo 'obj-$(CONFIG_RTL8188EUS) += rtl8188eus/' >> Makefile
          fi
          if ! grep -q "rtl88x2bu" Makefile 2>/dev/null; then
            echo 'obj-$(CONFIG_RTL8822BU) += rtl88x2bu/' >> Makefile
          fi
          
          echo "External drivers integrated."
          
          # Add configs
          CONFIG_FILE=../../../arch/arm64/configs/gki_defconfig
          echo "" >> "$CONFIG_FILE"
          echo "# OUT-OF-TREE WIFI DRIVERS" >> "$CONFIG_FILE"
          echo "CONFIG_88XXAU=y" >> "$CONFIG_FILE"
          echo "CONFIG_RTL8814AU=y" >> "$CONFIG_FILE"
          echo "CONFIG_RTL8188EUS=y" >> "$CONFIG_FILE"
          echo "CONFIG_RTL8822BU=y" >> "$CONFIG_FILE"

      # ==========================================
      # BUILD FIXES
      # ==========================================
      - name: Fix Build Issues
        run: |
          sed -i '/goto show_pad;/d' kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      - name: Custom Build Time
        if: ${{ github.event.inputs.BUILD_TIME != '' && github.event.inputs.BUILD_TIME != 'F' }}
        run: |
          DATESTR="${{ github.event.inputs.BUILD_TIME }}"
          echo "KBUILD_BUILD_TIMESTAMP=${DATESTR}" >> "$GITHUB_ENV"
          echo "KBUILD_BUILD_VERSION=1" >> "$GITHUB_ENV"

      # ==========================================
      # BUILD
      # ==========================================
      - name: Build Kernel
        run: |
          cd kernel_workspace/
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache clang"
          ./build/build.sh
          ccache -s

      - name: Verify Kernel Build
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          
          if [ ! -f "$IMAGE" ]; then
            echo "ERROR: Image.gz not found!"
            exit 1
          fi
          
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: Image.gz too small!"
            exit 1
          fi
          
          echo "Kernel built successfully!"

      # ==========================================
      # PACKAGE
      # ==========================================
      - name: Create AnyKernel3 Package
        run: |
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1 Anykernel3_Zabixii
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz Anykernel3_Zabixii/Image.gz

      - name: Set Artifact Suffix
        id: suffix
        run: |
          KSU_SUFFIX=""
          if [ "${{ github.event.inputs.KSU }}" = "true" ]; then
            KSU_SUFFIX="_KSU"
            if [ "${{ github.event.inputs.VFS }}" = "true" ]; then
              KSU_SUFFIX="${KSU_SUFFIX}_VFS"
            fi
            if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
              KSU_SUFFIX="${KSU_SUFFIX}_KPM"
            fi
          else
            KSU_SUFFIX="_MAGISK"
          fi
          NH_SUFFIX=""
          if [ "${{ github.event.inputs.NETHUNTER }}" = "true" ]; then
            NH_SUFFIX="_NH"
            if [ "${{ github.event.inputs.WIFI_DRIVERS }}" = "true" ]; then
              NH_SUFFIX="${NH_SUFFIX}_WIFI"
            fi
          fi
          echo "value=${KSU_SUFFIX}${NH_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "Zabixii_Kernel${{ steps.suffix.outputs.value }}_by_Zabixii"
          path: ./Anykernel3_Zabixii/*

      - name: Post-Build Disk Check
        run: df -h
