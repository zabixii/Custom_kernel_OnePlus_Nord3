# ============================================
# Zabixii Kernel Build Workflow
# Version: 3.4.0 - WiFi Only Test
# ============================================
# STRATEGY: Add ONLY WiFi drivers (=m).
# If this boots, add more one at a time.
# ============================================

name: Build Zabixii v3.4.0 - WiFi Only

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"

jobs:
  build:
    name: "[MAGISK] [NH-WiFi] ${{ github.event.inputs.SUFFIX }}"
    runs-on: ubuntu-latest
    steps:
      - name: Set Environment Variables
        run: |
          echo "CPU=mt6983" >> $GITHUB_ENV
          echo "ANDROID_VERSION=android12" >> $GITHUB_ENV
          echo "KERNEL_VERSION=5.10" >> $GITHUB_ENV

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Checkout
        uses: actions/checkout@v4

      - name: "[STEP 1] Patch config - WiFi ONLY"
        run: |
          CONFIG_FILE="./config_android12-5.10_kernel-5.10.txt"
          WORK_CONFIG="/tmp/nethunter_config.txt"
          cp "$CONFIG_FILE" "$WORK_CONFIG"
          
          add_module() {
            local C="$1"
            if grep -q "^${C}=y" "$WORK_CONFIG"; then
              echo "  SKIP $C (=y)"
            elif grep -q "^${C}=m" "$WORK_CONFIG"; then
              echo "  SKIP $C (=m)"
            elif grep -q "^# ${C} is not set" "$WORK_CONFIG"; then
              sed -i "s|^# ${C} is not set|${C}=m|" "$WORK_CONFIG"
              echo "  SET $C=m (was not set)"
            else
              echo "${C}=m" >> "$WORK_CONFIG"
              echo "  ADD $C=m"
            fi
          }
          
          add_bool() {
            local C="$1"
            if grep -q "^${C}=y" "$WORK_CONFIG"; then
              echo "  SKIP $C (=y)"
            elif grep -q "^# ${C} is not set" "$WORK_CONFIG"; then
              sed -i "s|^# ${C} is not set|${C}=y|" "$WORK_CONFIG"
              echo "  SET $C=y (was not set)"
            else
              echo "${C}=y" >> "$WORK_CONFIG"
              echo "  ADD $C=y"
            fi
          }
          
          echo "=============================================="
          echo "  WiFi ONLY - Minimal NetHunter"
          echo "=============================================="
          echo ""
          echo "--- MAC80211 ---"
          add_module "CONFIG_MAC80211"
          add_bool "CONFIG_MAC80211_HAS_RC"
          add_bool "CONFIG_MAC80211_RC_MINSTREL"
          add_bool "CONFIG_MAC80211_RC_DEFAULT_MINSTREL"
          add_bool "CONFIG_MAC80211_MESH"
          echo ""
          echo "--- MT76 ---"
          add_module "CONFIG_MT76_CORE"
          add_module "CONFIG_MT76_USB"
          add_module "CONFIG_MT76x02_LIB"
          add_module "CONFIG_MT76x02_USB"
          add_module "CONFIG_MT76x2_COMMON"
          add_module "CONFIG_MT76x2U"
          echo ""
          echo "--- MT7601U ---"
          add_module "CONFIG_MT7601U"
          echo ""
          echo "--- ATH9K ---"
          add_module "CONFIG_ATH_COMMON"
          add_module "CONFIG_ATH9K"
          add_module "CONFIG_ATH9K_HW"
          add_module "CONFIG_ATH9K_COMMON"
          add_module "CONFIG_ATH9K_HTC"
          echo ""
          echo "--- RT2800 ---"
          add_module "CONFIG_RT2X00"
          add_module "CONFIG_RT2800_LIB"
          add_module "CONFIG_RT2800USB"
          echo ""
          echo "--- RTL ---"
          add_module "CONFIG_RTL8XXXU"
          add_module "CONFIG_RTL8187"
          echo ""
          echo "=============================================="
          echo "Original =y: $(grep -c '=y' "$CONFIG_FILE")"
          echo "Patched =y:  $(grep -c '=y' "$WORK_CONFIG")"
          echo "Original =m: $(grep -c '=m' "$CONFIG_FILE")"
          echo "Patched =m:  $(grep -c '=m' "$WORK_CONFIG")"
          echo "=============================================="

      - name: Upload Patched Config
        uses: actions/upload-artifact@v4
        with:
          name: "Patched_Config_WiFi_Only"
          path: /tmp/nethunter_config.txt

      - name: Configure Git
        run: |
          git config --global user.name "zabixii"
          git config --global user.email "154690973+zabixii@users.noreply.github.com"

      - name: Install Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y python3 git curl libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip llvm lld

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Copy Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          rm -rf kernel_module

      - name: Vendor Fixes
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile
          
          cd $GITHUB_WORKSPACE/kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF
          
          cd $GITHUB_WORKSPACE/kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c
          
          sed -i '/goto show_pad;/d' $GITHUB_WORKSPACE/kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      - name: Apply Suffix
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          SCRIPT="kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion"
          sed -i 's/ -dirty//g' "$SCRIPT"
          echo "" >> "$SCRIPT"
          echo "echo \"-${{ env.ANDROID_VERSION }}-${SUFFIX}\"" >> "$SCRIPT"
          echo "exit 0" >> "$SCRIPT"
          chmod +x "$SCRIPT"
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX" || true

      - name: Disable check_defconfig
        run: |
          cd kernel_workspace/kernel-5.10
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: "[STEP 5] Patch build.sh + inject config"
        run: |
          cd kernel_workspace
          BUILD_SH="./build/build.sh"
          
          # Kill ALL olddefconfig calls
          sed -i 's|make.*olddefconfig|echo "SKIPPED olddefconfig"|g' "$BUILD_SH"
          sed -i 's|\${MAKE}.*olddefconfig|echo "SKIPPED olddefconfig"|g' "$BUILD_SH"
          
          # Also kill syncconfig which make calls internally
          # by setting KCONFIG_ALLCONFIG to our config
          echo "export KCONFIG_ALLCONFIG=/tmp/nethunter_config.txt" >> kernel-5.10/build.config.oplus6983
          
          # Setup injection
          cd kernel-5.10
          cat > inject_config.sh << 'SCRIPT'
          #!/bin/bash
          echo "=== INJECTING CONFIG v3.4.0 ==="
          cp /tmp/nethunter_config.txt "${OUT_DIR}/.config"
          echo "Injected: $(grep -c '=y' "${OUT_DIR}/.config") =y, $(grep -c '=m' "${OUT_DIR}/.config") =m"
          SCRIPT
          chmod +x inject_config.sh
          
          if grep -q "POST_DEFCONFIG_CMDS" build.config.oplus6983; then
            sed -i 's|POST_DEFCONFIG_CMDS="\(.*\)"|POST_DEFCONFIG_CMDS="${KERNEL_DIR}/inject_config.sh"|' build.config.oplus6983
          else
            echo 'POST_DEFCONFIG_CMDS="${KERNEL_DIR}/inject_config.sh"' >> build.config.oplus6983
          fi

      - name: "[STEP 6] Build"
        run: |
          cd kernel_workspace/
          rm -rf out/
          ./build/build.sh 2>&1 | tee /tmp/build.log

      - name: "[STEP 7] Verify"
        if: always()
        run: |
          FINAL=$(find kernel_workspace/out/ -name ".config" -type f 2>/dev/null | head -1)
          ORIG="./config_android12-5.10_kernel-5.10.txt"
          PATCHED="/tmp/nethunter_config.txt"
          
          if [ -n "$FINAL" ]; then
            cp "$FINAL" /tmp/final_built_config.txt
            
            echo "=== Counts ==="
            echo "Patched: =y=$(grep -c '=y' "$PATCHED") =m=$(grep -c '=m' "$PATCHED")"
            echo "Final:   =y=$(grep -c '=y' "$FINAL") =m=$(grep -c '=m' "$FINAL")"
            echo ""
            
            echo "=== Identical? ==="
            if diff -q "$PATCHED" "$FINAL" > /dev/null 2>&1; then
              echo "YES - exact match!"
            else
              echo "NO - differences:"
              diff "$PATCHED" "$FINAL" | head -40
            fi
            echo ""
            
            echo "=== Dangerous configs ==="
            for cfg in CONFIG_BRIDGE CONFIG_VETH CONFIG_USB_F_HID CONFIG_USB_CONFIGFS_F_HID CONFIG_PPTP; do
              grep "^${cfg}=" "$FINAL" || echo "$cfg: not present (good)"
            done
            echo ""
            
            echo "=== WiFi configs ==="
            grep -E "CONFIG_(MAC80211|MT76|MT7601U|ATH9K|RT2X00|RT2800|RTL8)=" "$FINAL" | sort
          fi

      - name: Verify Image
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          if [ ! -f "$IMAGE" ]; then exit 1; fi
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz: $SIZE bytes"

      - name: Package
        run: |
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1 Anykernel3_Zabixii
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz Anykernel3_Zabixii/Image.gz

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: "Zabixii_WiFi_Only"
          path: ./Anykernel3_Zabixii/*

      - name: Upload Configs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "Configs_v3.4.0"
          path: |
            /tmp/nethunter_config.txt
            /tmp/final_built_config.txt

      - name: Upload Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "Build_Log"
          path: /tmp/build.log
