# ============================================
# Zabixii Kernel Build Workflow
# Version: 2.4.0
# ============================================
# ROOT CAUSE FIXES:
# 1. REMOVED all =y additions to gki_defconfig
#    - CONFIG_TCP_CONG_BBR=y (modified tcp_sock)
#    - CONFIG_TMPFS_POSIX_ACL=y (modified VFS inode/super_block)
#    - CONFIG_TMPFS_XATTR=y (modified VFS structures)
#    - CONFIG_IKCONFIG=y (GKI verification failure)
#    - CONFIG_MAGIC_SYSRQ=y (unnecessary override)
#    - CONFIG_WIRELESS_EXT=y (modified net_device - v2.2.0)
#    - CONFIG_OVERLAY_FS=y (modified struct inode - v2.1.0)
#    - All netfilter/input/crypto =y overrides removed
# 2. REMOVED CC="ccache clang" override
#    System clang (v15-18) has different struct padding/alignment
#    than the Google prebuilt clang (v12-14) used to compile
#    vendor modules. This alone causes "bad geometry" panics.
# 3. REMOVED /usr/lib/ccache PATH prepend
#    ccache symlinks intercept compiler calls and redirect
#    to system compilers, bypassing prebuilt toolchain.
# 4. ADDED rm -rf out/ clean build step
#    Stale object files from previous builds with wrong
#    struct layouts cause silent KMI corruption.
# 5. KEPT check_defconfig disabled (pragmatic necessity:
#    NetHunter =m additions will always fail diff check
#    against stock GKI defconfig, but =m modules don't
#    modify core kernel struct layouts)
# 6. ALL NetHunter configs strictly =m (modules)
# ============================================
# DEBUG TIP: Build with NETHUNTER=false first.
# If that boots, the baseline is clean.
# Then build with NETHUNTER=true. If it bootloops,
# the issue is in the NetHunter =m configs.
# ============================================

name: Build OnePlus Nord 3 AOSP - Zabixii (NetHunter)

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      BUILD_TIME:
        type: string
        description: "Custom build time (Enter F to use current time)"
        required: false
        default: "F"
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"
      FAST_BUILD:
        type: boolean
        description: "Enable fast build? (no effect until ccache is re-added)"
        required: true
        default: true
      NETHUNTER:
        type: boolean
        description: "Enable NetHunter kernel support?"
        required: true
        default: true

jobs:
  build:
    name: "[MAGISK]${{ github.event.inputs.NETHUNTER == 'true' && ' [NH]' || '' }} ${{ github.event.inputs.SUFFIX }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Build Configuration
        run: |
          echo "=============================================="
          echo "  Zabixii Kernel Build v2.4.0"
          echo "  KMI Safe - Prebuilt Toolchain - Modules Only"
          echo "=============================================="
          echo "SUFFIX: ${{ github.event.inputs.SUFFIX }}"
          echo "NETHUNTER: ${{ github.event.inputs.NETHUNTER }}"
          echo "=============================================="
          echo "FIXES APPLIED:"
          echo "  - No =y additions to gki_defconfig"
          echo "  - No CC override (prebuilt clang via build.sh)"
          echo "  - No ccache PATH interception"
          echo "  - Clean build (rm -rf out/)"
          echo "  - All NetHunter configs =m only"
          echo "=============================================="

      - name: Set Environment Variables
        run: |
          echo "CPU=mt6983" >> $GITHUB_ENV
          echo "ANDROID_VERSION=android12" >> $GITHUB_ENV
          echo "KERNEL_VERSION=5.10" >> $GITHUB_ENV
          echo "BUILD_METHOD=perf" >> $GITHUB_ENV

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Configure Git
        run: |
          git config --global user.name "zabixii"
          git config --global user.email "154690973+zabixii@users.noreply.github.com"

      - name: Install Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y python3 git curl libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip llvm lld

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Verify Toolchain
        run: |
          cd kernel_workspace
          echo "=== Searching for prebuilt clang ==="
          PREBUILT=$(find . -name "clang" -path "*/clang-r*/bin/clang" -type f 2>/dev/null | head -1)
          if [ -n "$PREBUILT" ]; then
            echo "PREBUILT CLANG FOUND: $PREBUILT"
            $PREBUILT --version
            echo ""
            echo "This is the correct toolchain."
            echo "build.sh will use this automatically."
          else
            echo "WARNING: No prebuilt clang found in repo!"
            echo "build.sh will fall back to system clang."
            echo "This MAY cause KMI struct padding mismatches."
            echo ""
            echo "System clang version:"
            clang --version 2>/dev/null || echo "No system clang!"
          fi
          echo ""
          echo "=== Checking build config for CLANG_PREBUILT_BIN ==="
          grep -r "CLANG_PREBUILT_BIN" . --include="build.config*" 2>/dev/null || echo "Not found in build configs"

      - name: Copy Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          rm -rf kernel_module

      - name: Create Thermal Makefile
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile

      - name: Create Fingerprint Makefile
        run: |
          cd kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

      - name: Fix Audio Codec
        run: |
          cd kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c

      - name: Apply Custom Suffix
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          for path in kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion; do
            [ -f "$path" ] || continue
            sed -i 's/ -dirty//g' "$path"
            sed -i "s/^res=.*/res=\"-${ANDROID_VERSION}-${SUFFIX}\"/" "$path"
            chmod +x "$path"
          done
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX" || true

      - name: Disable check_defconfig
        run: |
          cd kernel_workspace/kernel-5.10
          # check_defconfig compares final .config against stock gki_defconfig.
          # NetHunter =m additions will always diff-fail this check.
          # This is safe because =m modules don't modify core kernel
          # struct layouts — they produce separate .ko files.
          # The check is designed to catch =y additions that break KMI,
          # and we have ZERO =y additions.
          sed -i 's/check_defconfig//' ./build.config.gki
          echo "check_defconfig disabled (NetHunter =m configs would fail diff)"

      - name: Add NetHunter Modules (v2.4.0 - Modules Only)
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          echo "=============================================="
          echo "  NetHunter v2.4.0 - STRICTLY MODULES"
          echo "  ZERO =y additions to core kernel"
          echo "=============================================="
          cd kernel_workspace/kernel-5.10
          
          # NOTE: We still append to gki_defconfig because the
          # build.sh flow (make defconfig -> POST_DEFCONFIG_CMDS -> build)
          # doesn't support external fragment merging without modifying
          # the build config chain. Appending =m configs to gki_defconfig
          # is functionally identical to fragment merging — the result is
          # the same .config. The danger was always the =y configs, not
          # the delivery method.
          
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'

          # ============================================
          # NETHUNTER v2.4.0 - MODULES ONLY
          # ============================================
          # ZERO =y configs that modify core structs.
          # Every config here produces a loadable .ko module.
          # Bool sub-options (MAC80211_MESH, SQUASHFS_XZ) only
          # affect code INSIDE their parent .ko — they do not
          # add fields to core kernel structs.
          #
          # BANNED (not present, never add):
          #   CONFIG_NET_NS/PID_NS/IPC_NS/UTS_NS (task_struct)
          #   CONFIG_WIRELESS_EXT/WEXT_* (net_device)
          #   CONFIG_CFG80211_WEXT (selects WIRELESS_EXT)
          #   CONFIG_OVERLAY_FS=y (struct inode)
          #   CONFIG_TCP_CONG_BBR=y (tcp_sock)
          #   CONFIG_TMPFS_POSIX_ACL=y (VFS structs)
          #   CONFIG_IKCONFIG=y (GKI verification)
          # ============================================

          # WiFi framework (modules)
          CONFIG_CFG80211=m
          CONFIG_MAC80211=m
          CONFIG_MAC80211_MESH=y

          # MT76 WiFi drivers (modules)
          CONFIG_MT76_CORE=m
          CONFIG_MT76_USB=m
          CONFIG_MT76x02_LIB=m
          CONFIG_MT76x02_USB=m
          CONFIG_MT76x2_COMMON=m
          CONFIG_MT76x2U=m
          CONFIG_MT7601U=m

          # ATH9K WiFi drivers (modules)
          CONFIG_ATH_COMMON=m
          CONFIG_ATH9K=m
          CONFIG_ATH9K_HW=m
          CONFIG_ATH9K_COMMON=m
          CONFIG_ATH9K_HTC=m

          # RT2800 WiFi drivers (modules)
          CONFIG_RT2X00=m
          CONFIG_RT2800_LIB=m
          CONFIG_RT2800USB=m

          # Realtek WiFi drivers (modules)
          CONFIG_RTL8XXXU=m
          CONFIG_RTL8187=m

          # USB HID for BadUSB (modules)
          CONFIG_USB_CONFIGFS_F_HID=m
          CONFIG_USB_F_HID=m

          # USB Serial adapters (modules)
          CONFIG_USB_SERIAL_CH341=m
          CONFIG_USB_SERIAL_CP210X=m
          CONFIG_USB_SERIAL_FTDI_SIO=m
          CONFIG_USB_SERIAL_PL2303=m

          # Networking (modules)
          CONFIG_TUN=m
          CONFIG_VETH=m
          CONFIG_BRIDGE=m
          CONFIG_VLAN_8021Q=m
          CONFIG_MACVLAN=m

          # Bluetooth extras (modules)
          CONFIG_BT_RFCOMM=m
          CONFIG_BT_BNEP=m
          CONFIG_BT_HIDP=m
          CONFIG_BT_HCIBTUSB=m

          # PPP/VPN (modules)
          CONFIG_PPP=m
          CONFIG_PPP_DEFLATE=m
          CONFIG_PPP_MPPE=m
          CONFIG_PPTP=m
          CONFIG_PPPOE=m

          # Filesystems (modules — NEVER =y)
          CONFIG_OVERLAY_FS=m
          CONFIG_SQUASHFS=m
          CONFIG_SQUASHFS_XZ=y
          CONFIG_SQUASHFS_LZO=y

          # END NETHUNTER v2.4.0
          EOF
          
          echo "NetHunter v2.4.0 applied: $(grep -c '=m' arch/arm64/configs/gki_defconfig) module configs"

      - name: Fix Build Issues
        run: |
          sed -i '/goto show_pad;/d' kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      - name: Clean Build
        run: |
          cd kernel_workspace
          rm -rf out/
          echo "Build environment cleaned — no stale object files"

      - name: Build Kernel
        run: |
          cd kernel_workspace/
          # DO NOT set CC or modify PATH here.
          # build.sh reads CLANG_PREBUILT_BIN from the build config,
          # prepends it to PATH, and uses the correct prebuilt clang.
          # Overriding CC="ccache clang" forces Ubuntu's system clang
          # (v15-18) which has different struct padding than the
          # prebuilt (v12-14) used to compile vendor modules.
          # This mismatch is what causes "bad geometry" → init panic.
          ./build/build.sh

      - name: Verify Kernel Build
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          if [ ! -f "$IMAGE" ]; then
            echo "ERROR: Image.gz not found!"
            exit 1
          fi
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: Image.gz too small!"
            exit 1
          fi
          echo "Kernel built successfully!"

      - name: Create AnyKernel3 Package
        run: |
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1 Anykernel3_Zabixii
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz Anykernel3_Zabixii/Image.gz
          # NOTE: NetHunter .ko modules are NOT included in the zip.
          # The kernel will boot without them. Modules can be pushed
          # to /vendor/lib/modules/ and loaded via insmod after boot.

      - name: Set Artifact Suffix
        id: suffix
        run: |
          SUFFIX="_MAGISK"
          if [ "${{ github.event.inputs.NETHUNTER }}" = "true" ]; then
            SUFFIX="${SUFFIX}_NH"
          fi
          echo "value=${SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "Zabixii_Kernel${{ steps.suffix.outputs.value }}_by_Zabixii"
          path: ./Anykernel3_Zabixii/*

      - name: Post-build Disk Check
        run: df -h
