# ============================================
# Zabixii Kernel Build Workflow
# Version: 1.5.0
# - Magisk only (no KSU)
# - Fixed NetHunter step conditions
# ============================================

name: Build OnePlus Nord 3 AOSP - Zabixii (NetHunter)

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      BUILD_TIME:
        type: string
        description: "Custom build time (Enter F to use current time)"
        required: false
        default: "F"
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"
      FAST_BUILD:
        type: boolean
        description: "Enable fast build?"
        required: true
        default: true
      NETHUNTER:
        type: boolean
        description: "Enable NetHunter kernel support?"
        required: true
        default: true

jobs:
  build:
    name: "[MAGISK]${{ github.event.inputs.NETHUNTER == 'true' && ' [NH]' || '' }} ${{ github.event.inputs.SUFFIX }}"
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Build Configuration
        run: |
          echo "=============================================="
          echo "  Zabixii Kernel Build v1.5.0"
          echo "=============================================="
          echo "FILE: ${{ github.event.inputs.FILE }}"
          echo "SUFFIX: ${{ github.event.inputs.SUFFIX }}"
          echo "NETHUNTER: ${{ github.event.inputs.NETHUNTER }}"
          echo "FAST_BUILD: ${{ github.event.inputs.FAST_BUILD }}"
          echo "=============================================="

      - name: Set Environment Variables
        run: |
          echo "CPU=mt6983" >> $GITHUB_ENV
          echo "ANDROID_VERSION=android12" >> $GITHUB_ENV
          echo "KERNEL_VERSION=5.10" >> $GITHUB_ENV
          echo "BUILD_METHOD=perf" >> $GITHUB_ENV

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Set Cache Environment
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Configure Git
        run: |
          git config --global user.name "hemasai1109"
          git config --global user.email "pandunelluri.1109@gmail.com"

      - name: Install Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip llvm lld

      - name: Restore Ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.event.inputs.FILE }}-v4

      - name: Initialize Ccache
        run: |
          mkdir -p "${{ env.CCACHE_DIR }}"
          ccache -M ${{ env.CCACHE_MAXSIZE }}

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Copy Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          rm -rf kernel_module

      - name: Create Thermal Makefile
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile

      - name: Create Fingerprint Makefile
        run: |
          cd kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

      - name: Fix Audio Codec
        run: |
          cd kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c

      - name: Apply Custom Suffix
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          for path in kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion; do
            [ -f "$path" ] || continue
            sed -i 's/ -dirty//g' "$path"
            sed -i "s/^res=.*/res=\"-${ANDROID_VERSION}-${SUFFIX}\"/" "$path"
            chmod +x "$path"
          done
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX" || true

      - name: Add Common Optimizations
        run: |
          cd kernel_workspace/kernel-5.10
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          EOF
          sed -i 's/check_defconfig//' ./build.config.gki
          echo "Common optimizations added!"

      - name: NetHunter - Clone MT76 Driver
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          echo "=============================================="
          echo "  NETHUNTER: Cloning MT76 Driver"
          echo "=============================================="
          cd kernel_workspace/kernel-5.10/drivers/net/wireless
          
          mkdir -p mediatek
          cd mediatek
          
          if [ -d "mt76" ]; then
            rm -rf mt76
          fi
          
          git clone --depth=1 https://github.com/openwrt/mt76.git
          
          if [ ! -d "mt76" ]; then
            echo "ERROR: Failed to clone MT76!"
            exit 1
          fi
          
          echo "MT76 cloned successfully!"
          ls -la mt76/

      - name: NetHunter - Fix MT76 Kconfig
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          echo "=============================================="
          echo "  NETHUNTER: Fixing MT76 Kconfig"
          echo "=============================================="
          cd kernel_workspace/kernel-5.10/drivers/net/wireless/mediatek/mt76
          
          find . -name "Kconfig" -exec sed -i 's/---help---/help/g' {} \;
          
          cat > Kconfig << 'EOF'
          config MT76_CORE
          	tristate
          	depends on MAC80211
          
          config MT76_USB
          	tristate
          	depends on MT76_CORE && USB
          
          config MT76x02_LIB
          	tristate
          	depends on MT76_CORE
          
          config MT76x02_USB
          	tristate
          	depends on MT76_USB && MT76x02_LIB
          
          config MT76x2_COMMON
          	tristate
          	depends on MT76_CORE
          
          config MT76x2U
          	tristate "MediaTek MT76x2U (USB) support"
          	depends on MAC80211 && USB
          	select MT76_CORE
          	select MT76_USB
          	select MT76x02_LIB
          	select MT76x02_USB
          	select MT76x2_COMMON
          	help
          	  This adds support for MT7612U-based USB wireless adapters.
          EOF
          
          echo "Kconfig fixed!"

      - name: NetHunter - Integrate MT76 into Kernel
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          echo "=============================================="
          echo "  NETHUNTER: Integrating MT76 into Kernel"
          echo "=============================================="
          cd kernel_workspace/kernel-5.10/drivers/net/wireless/mediatek
          
          cat > Makefile << 'EOF'
          obj-$(CONFIG_MT76_CORE) += mt76/
          EOF
          
          cat > Kconfig << 'EOF'
          source "drivers/net/wireless/mediatek/mt76/Kconfig"
          EOF
          
          cd ..
          
          if ! grep -q "mediatek" Makefile; then
            echo "obj-y += mediatek/" >> Makefile
          fi
          
          if ! grep -q "mediatek" Kconfig; then
            echo 'source "drivers/net/wireless/mediatek/Kconfig"' >> Kconfig
          fi
          
          echo "Integration complete!"

      - name: NetHunter - Add All Configs
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          echo "=============================================="
          echo "  NETHUNTER: Adding All Configs"
          echo "=============================================="
          cd kernel_workspace/kernel-5.10
          
          cat >> arch/arm64/configs/gki_defconfig << 'NHEOF'
          # NetHunter Marker
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_MAGIC_SYSRQ=y
          # USB HID
          CONFIG_USB_CONFIGFS_F_HID=y
          CONFIG_USB_F_HID=y
          # USB Serial
          CONFIG_USB_SERIAL_CH341=y
          CONFIG_USB_SERIAL_CP210X=y
          CONFIG_USB_SERIAL_FTDI_SIO=y
          CONFIG_USB_SERIAL_PL2303=y
          # Wireless
          CONFIG_WIRELESS=y
          CONFIG_WIRELESS_EXT=y
          CONFIG_WEXT_CORE=y
          CONFIG_WEXT_PROC=y
          CONFIG_WEXT_PRIV=y
          CONFIG_CFG80211=y
          CONFIG_CFG80211_WEXT=y
          CONFIG_MAC80211=y
          CONFIG_MAC80211_MESH=y
          CONFIG_RFKILL=y
          # MT76
          CONFIG_MT76_CORE=y
          CONFIG_MT76_USB=y
          CONFIG_MT76x02_LIB=y
          CONFIG_MT76x02_USB=y
          CONFIG_MT76x2_COMMON=y
          CONFIG_MT76x2U=y
          # Networking
          CONFIG_TUN=y
          CONFIG_VETH=y
          CONFIG_BRIDGE=y
          CONFIG_VLAN_8021Q=y
          CONFIG_MACVLAN=y
          # Input
          CONFIG_INPUT_UINPUT=y
          CONFIG_UHID=y
          # Netfilter
          CONFIG_NETFILTER_XT_TARGET_TPROXY=y
          CONFIG_NETFILTER_XT_TARGET_TEE=y
          CONFIG_NETFILTER_XT_TARGET_LOG=y
          CONFIG_NETFILTER_XT_MATCH_U32=y
          CONFIG_NETFILTER_XT_MATCH_STRING=y
          CONFIG_NETFILTER_XT_MATCH_MULTIPORT=y
          CONFIG_NETFILTER_XT_MATCH_MARK=y
          CONFIG_NETFILTER_XT_MATCH_MAC=y
          CONFIG_NETFILTER_XT_MATCH_IPRANGE=y
          CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y
          # Namespaces
          CONFIG_NET_NS=y
          CONFIG_PID_NS=y
          CONFIG_IPC_NS=y
          CONFIG_UTS_NS=y
          # Bluetooth
          CONFIG_BT_RFCOMM=y
          CONFIG_BT_RFCOMM_TTY=y
          CONFIG_BT_BNEP=y
          CONFIG_BT_HIDP=y
          CONFIG_BT_HCIBTUSB=y
          # PPP
          CONFIG_PPP=y
          CONFIG_PPP_DEFLATE=y
          CONFIG_PPP_MPPE=y
          CONFIG_PPTP=y
          CONFIG_PPPOE=y
          # Filesystems
          CONFIG_OVERLAY_FS=y
          CONFIG_SQUASHFS=y
          CONFIG_SQUASHFS_XZ=y
          CONFIG_SQUASHFS_LZO=y
          # Crypto
          CONFIG_CRYPTO_USER_API_HASH=y
          CONFIG_CRYPTO_USER_API_SKCIPHER=y
          NHEOF
          
          if [ -f "arch/arm64/configs/mgk_64_k510_defconfig" ]; then
            cat >> arch/arm64/configs/mgk_64_k510_defconfig << 'NHEOF'
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_MT76_CORE=y
          CONFIG_MT76_USB=y
          CONFIG_MT76x02_LIB=y
          CONFIG_MT76x02_USB=y
          CONFIG_MT76x2_COMMON=y
          CONFIG_MT76x2U=y
          CONFIG_CFG80211=y
          CONFIG_MAC80211=y
          NHEOF
          fi
          
          if [ -f "kernel/configs/oplus6983.config" ]; then
            cat >> kernel/configs/oplus6983.config << 'NHEOF'
          CONFIG_IKCONFIG=y
          CONFIG_IKCONFIG_PROC=y
          CONFIG_MT76_CORE=y
          CONFIG_MT76_USB=y
          CONFIG_MT76x02_LIB=y
          CONFIG_MT76x02_USB=y
          CONFIG_MT76x2_COMMON=y
          CONFIG_MT76x2U=y
          CONFIG_CFG80211=y
          CONFIG_MAC80211=y
          NHEOF
          fi
          
          echo "All NetHunter configs added!"

      - name: NetHunter - Verify Patches
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          echo "=============================================="
          echo "  NETHUNTER: Verifying All Patches"
          echo "=============================================="
          cd kernel_workspace/kernel-5.10
          
          ERRORS=0
          
          if [ -d "drivers/net/wireless/mediatek/mt76" ]; then
            echo "✅ MT76 driver exists"
          else
            echo "❌ MT76 driver NOT found!"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -q "mediatek" drivers/net/wireless/Makefile; then
            echo "✅ MT76 in wireless Makefile"
          else
            echo "❌ MT76 NOT in Makefile!"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -q "CONFIG_MT76x2U" arch/arm64/configs/gki_defconfig; then
            echo "✅ MT76x2U in gki_defconfig"
          else
            echo "❌ MT76x2U NOT in gki_defconfig!"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -q "CONFIG_IKCONFIG_PROC" arch/arm64/configs/gki_defconfig; then
            echo "✅ IKCONFIG_PROC in gki_defconfig"
          else
            echo "❌ IKCONFIG_PROC NOT in gki_defconfig!"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -eq 0 ]; then
            echo "=============================================="
            echo "  ✅ ALL PATCHES VERIFIED!"
            echo "=============================================="
          else
            echo "=============================================="
            echo "  ❌ $ERRORS ERRORS FOUND!"
            echo "=============================================="
            exit 1
          fi

      - name: Fix show_pad Error
        run: |
          sed -i '/goto show_pad;/d' kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      - name: Build Kernel
        run: |
          cd kernel_workspace/
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache clang"
          ./build/build.sh
          ccache -s

      - name: Verify Kernel Build
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          if [ ! -f "$IMAGE" ]; then
            echo "ERROR: Image.gz not found!"
            exit 1
          fi
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz size: $SIZE bytes"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: Image.gz too small!"
            exit 1
          fi
          echo "✅ Kernel built successfully!"

      - name: Create AnyKernel3 Package
        run: |
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1 Anykernel3_Zabixii
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz Anykernel3_Zabixii/Image.gz

      - name: Set Artifact Suffix
        id: suffix
        run: |
          SUFFIX="_MAGISK"
          if [ "${{ github.event.inputs.NETHUNTER }}" = "true" ]; then
            SUFFIX="${SUFFIX}_NH"
          fi
          echo "value=${SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "Zabixii_Kernel${{ steps.suffix.outputs.value }}_by_Zabixii"
          path: ./Anykernel3_Zabixii/*
