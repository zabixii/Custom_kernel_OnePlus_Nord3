# ============================================
# Zabixii Kernel Build Workflow
# Version: 1.2.0
# ============================================

name: Build OnePlus Nord 3 AOSP - Zabixiiâš¡ (NetHunter)

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      BUILD_TIME:
        type: string
        description: "Custom build time (Enter F to use current time)"
        required: false
        default: "F"
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"
      KSU:
        type: boolean
        description: "Enable KernelSU/SukiSU? (false = Magisk only)"
        required: true
        default: false
      SUSFS_CI:
        type: choice
        description: "SUSFS module download method (only if KSU enabled)"
        required: true
        default: NoN
        options:
          - CI
          - Release
          - NoN
      KSU_META:
        type: string
        description: "Branch name/Custom version identifier (only if KSU enabled)"
        required: false
        default: ""
      FAST_BUILD:
        type: boolean
        description: "Enable fast build?"
        required: true
        default: true
      VFS:
        type: boolean
        description: "Enable manual hooks (VFS)? (only if KSU enabled)"
        required: true
        default: false
      KPM:
        type: boolean
        description: "Enable Kernel Patch Module (KPM)? (only if KSU enabled)"
        required: true
        default: false
      NETHUNTER:
        type: boolean
        description: "Enable NetHunter kernel support?"
        required: true
        default: false

jobs:
  notify_start:
    name: Notify Start
    runs-on: ubuntu-latest
    steps:
      - name: Get current time (IST)
        id: get_time
        run: echo "timestamp=$(TZ='Asia/Kolkata' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

  build:
    needs: notify_start
    name: ${{ github.event.inputs.FAST_BUILD == 'true' && '[FAST]' || '' }}${{ github.event.inputs.KSU == 'true' && ' [KSU]' || ' [MAGISK]' }}${{ github.event.inputs.NETHUNTER == 'true' && ' [NH]' || '' }} ${{ github.event.inputs.SUFFIX }}
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Input Combinations
        run: |
          echo "Validating input combinations..."
          FILE="${{ github.event.inputs.FILE }}"
          declare -A VALID_COMBINATIONS=(
            ["manifest_aosp"]="mt6983 android12 5.10"
          )
          get_combination() {
            local key="$1"
            while true; do
              if [[ -n "${VALID_COMBINATIONS[$key]+_}" ]]; then
                echo "${VALID_COMBINATIONS[$key]}"
                return 0
              fi
              if [[ "$key" =~ ^(.+)_([a-z]+)$ ]]; then
                key="${BASH_REMATCH[1]}"
              else
                return 1
              fi
            done
          }
          COMBINATION="$(get_combination "$FILE")" || {
            echo "Unknown FILE: $FILE"
            exit 1
          }
          read CPU ANDROID_VERSION KERNEL_VERSION <<< "$COMBINATION"
          echo "Valid: FILE=$FILE, CPU=$CPU, ANDROID=$ANDROID_VERSION, KERNEL=$KERNEL_VERSION"
          echo "CPU=$CPU" >> $GITHUB_ENV
          echo "ANDROID_VERSION=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$KERNEL_VERSION" >> $GITHUB_ENV
          if [[ "$ANDROID_VERSION" == "android12" && "$KERNEL_VERSION" == "5.10" ]]; then
            echo "BUILD_METHOD=perf" >> $GITHUB_ENV
          else
            echo "BUILD_METHOD=gki" >> $GITHUB_ENV
          fi

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Set Cache Environment
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Configure Git
        run: |
          git config --global user.name "hemasai1109"
          git config --global user.email "pandunelluri.1109@gmail.com"

      - name: Install Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y python3 git curl ccache libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip llvm lld

      - name: Restore Ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ runner.os }}-${{ github.event.inputs.FILE }}-${{ github.event.inputs.NETHUNTER }}-v1

      - name: Initialize Ccache
        run: |
          mkdir -p "${{ env.CCACHE_DIR }}"
          ccache -M ${{ env.CCACHE_MAXSIZE }}
          ccache -s

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Copy Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          rm -rf kernel_module

      - name: Create Thermal Makefile
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile

      - name: Create Fingerprint Makefile
        run: |
          cd kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

      - name: Fix Audio Codec
        run: |
          cd kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c

      - name: Apply Custom Suffix
        if: ${{ github.event.inputs.SUFFIX != '' }}
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          for path in kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion; do
            [ -f "$path" ] || continue
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"
            if grep -q 'echo "\$res"' "$path"; then
              sed -i "s/^res=.*/res=\"-${ANDROID_VERSION}-${SUFFIX}\"/" "$path"
            fi
            chmod +x "$path"
          done
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX" || true

      - name: Add SukiSU Ultra
        if: ${{ github.event.inputs.KSU == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          META="${{ github.event.inputs.KSU_META }}"
          BRANCH_NAME="${META%%/*}"
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s "$BRANCH_NAME"

      - name: Apply SukiSU Patches
        if: ${{ github.event.inputs.KSU == 'true' }}
        run: |
          cd kernel_workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}
          git clone https://github.com/ShirkNeko/SukiSU_patch.git
          cd kernel-5.10
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch ./
          cp ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/
          patch -p1 < 50_add_susfs_in_gki-${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}.patch || true
          cp ../SukiSU_patch/69_hide_stuff.patch ./
          patch -p1 -F 3 < 69_hide_stuff.patch || true

      - name: Apply VFS Hooks
        if: ${{ github.event.inputs.KSU == 'true' && github.event.inputs.VFS == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cp ../SukiSU_patch/hooks/syscall_hooks.patch ./
          patch -p1 -F 3 < syscall_hooks.patch

      - name: Add KSU Configuration
        if: ${{ github.event.inputs.KSU == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          echo "CONFIG_KSU=y" >> arch/arm64/configs/gki_defconfig
          if [ "${{ github.event.inputs.KPM }}" = "true" ]; then
            echo "CONFIG_KPM=y" >> arch/arm64/configs/gki_defconfig
          fi
          if [ "${{ github.event.inputs.VFS }}" = "true" ]; then
            echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/gki_defconfig
          else
            echo "CONFIG_KSU_SUSFS_SUS_SU=y" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KPROBES=y" >> arch/arm64/configs/gki_defconfig
          fi
          echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> arch/arm64/configs/gki_defconfig

      - name: Add Common Optimizations
        run: |
          cd kernel_workspace/kernel-5.10
          echo "CONFIG_TMPFS_XATTR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_TCP_CONG_BBR=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_NET_SCH_FQ=y" >> arch/arm64/configs/gki_defconfig
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Create NetHunter Config Injection Script
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cat > nethunter_inject.sh << 'NHEOF'
          #!/bin/bash
          CONFIG_PATH="$1"
          if [ ! -f "$CONFIG_PATH" ]; then
            echo "Config not found: $CONFIG_PATH"
            exit 0
          fi
          echo "Injecting NetHunter configs into: $CONFIG_PATH"
          
          # Use scripts/config to enable options
          SCRIPTS_CONFIG="./scripts/config --file $CONFIG_PATH"
          
          # Marker
          $SCRIPTS_CONFIG --enable CONFIG_IKCONFIG
          $SCRIPTS_CONFIG --enable CONFIG_IKCONFIG_PROC
          $SCRIPTS_CONFIG --enable CONFIG_MAGIC_SYSRQ
          
          # USB HID
          $SCRIPTS_CONFIG --enable CONFIG_USB_CONFIGFS_F_HID
          $SCRIPTS_CONFIG --enable CONFIG_USB_F_HID
          
          # USB Serial
          $SCRIPTS_CONFIG --enable CONFIG_USB_SERIAL_CH341
          $SCRIPTS_CONFIG --enable CONFIG_USB_SERIAL_CP210X
          $SCRIPTS_CONFIG --enable CONFIG_USB_SERIAL_FTDI_SIO
          $SCRIPTS_CONFIG --enable CONFIG_USB_SERIAL_PL2303
          
          # Wireless framework
          $SCRIPTS_CONFIG --enable CONFIG_WIRELESS
          $SCRIPTS_CONFIG --enable CONFIG_WIRELESS_EXT
          $SCRIPTS_CONFIG --enable CONFIG_WEXT_CORE
          $SCRIPTS_CONFIG --enable CONFIG_WEXT_PROC
          $SCRIPTS_CONFIG --enable CONFIG_WEXT_PRIV
          $SCRIPTS_CONFIG --enable CONFIG_CFG80211
          $SCRIPTS_CONFIG --enable CONFIG_CFG80211_WEXT
          $SCRIPTS_CONFIG --enable CONFIG_MAC80211
          $SCRIPTS_CONFIG --enable CONFIG_MAC80211_MESH
          $SCRIPTS_CONFIG --enable CONFIG_RFKILL
          
          # MT76 driver
          $SCRIPTS_CONFIG --enable CONFIG_MT76_CORE
          $SCRIPTS_CONFIG --enable CONFIG_MT76_USB
          $SCRIPTS_CONFIG --enable CONFIG_MT76x02_LIB
          $SCRIPTS_CONFIG --enable CONFIG_MT76x02_USB
          $SCRIPTS_CONFIG --enable CONFIG_MT76x2_COMMON
          $SCRIPTS_CONFIG --enable CONFIG_MT76x2U
          
          # Networking
          $SCRIPTS_CONFIG --enable CONFIG_TUN
          $SCRIPTS_CONFIG --enable CONFIG_VETH
          $SCRIPTS_CONFIG --enable CONFIG_BRIDGE
          $SCRIPTS_CONFIG --enable CONFIG_VLAN_8021Q
          $SCRIPTS_CONFIG --enable CONFIG_MACVLAN
          
          # Input
          $SCRIPTS_CONFIG --enable CONFIG_INPUT_UINPUT
          $SCRIPTS_CONFIG --enable CONFIG_UHID
          
          # Netfilter
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_TARGET_TPROXY
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_TARGET_TEE
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_TARGET_LOG
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_MATCH_U32
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_MATCH_STRING
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_MATCH_MULTIPORT
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_MATCH_MARK
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_MATCH_MAC
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_MATCH_IPRANGE
          $SCRIPTS_CONFIG --enable CONFIG_NETFILTER_XT_MATCH_CONNTRACK
          
          # Namespaces
          $SCRIPTS_CONFIG --enable CONFIG_NET_NS
          $SCRIPTS_CONFIG --enable CONFIG_PID_NS
          $SCRIPTS_CONFIG --enable CONFIG_IPC_NS
          $SCRIPTS_CONFIG --enable CONFIG_UTS_NS
          
          # Bluetooth
          $SCRIPTS_CONFIG --enable CONFIG_BT_RFCOMM
          $SCRIPTS_CONFIG --enable CONFIG_BT_RFCOMM_TTY
          $SCRIPTS_CONFIG --enable CONFIG_BT_BNEP
          $SCRIPTS_CONFIG --enable CONFIG_BT_HIDP
          $SCRIPTS_CONFIG --enable CONFIG_BT_HCIBTUSB
          
          # PPP
          $SCRIPTS_CONFIG --enable CONFIG_PPP
          $SCRIPTS_CONFIG --enable CONFIG_PPP_DEFLATE
          $SCRIPTS_CONFIG --enable CONFIG_PPP_MPPE
          $SCRIPTS_CONFIG --enable CONFIG_PPTP
          $SCRIPTS_CONFIG --enable CONFIG_PPPOE
          
          # Filesystems
          $SCRIPTS_CONFIG --enable CONFIG_OVERLAY_FS
          $SCRIPTS_CONFIG --enable CONFIG_SQUASHFS
          $SCRIPTS_CONFIG --enable CONFIG_SQUASHFS_XZ
          $SCRIPTS_CONFIG --enable CONFIG_SQUASHFS_LZO
          
          # Crypto
          $SCRIPTS_CONFIG --enable CONFIG_CRYPTO_USER_API_HASH
          $SCRIPTS_CONFIG --enable CONFIG_CRYPTO_USER_API_SKCIPHER
          
          echo "NetHunter config injection complete!"
          NHEOF
          chmod +x nethunter_inject.sh

      - name: Patch Build Script for NetHunter
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          cd kernel_workspace
          
          # Find the build script
          BUILD_SCRIPT="build/build.sh"
          
          if [ -f "$BUILD_SCRIPT" ]; then
            echo "Patching build script..."
            
            # Add hook after defconfig generation
            sed -i '/make.*defconfig/a \
          # NetHunter config injection\
          if [ -f "${KERNEL_DIR}/nethunter_inject.sh" ]; then\
            echo "Running NetHunter config injection..."\
            bash "${KERNEL_DIR}/nethunter_inject.sh" "${OUT_DIR}/.config"\
            make -C ${KERNEL_DIR} O=${OUT_DIR} olddefconfig\
          fi' "$BUILD_SCRIPT"
            
            echo "Build script patched!"
          fi

      - name: Fix show_pad Error
        run: |
          sed -i '/goto show_pad;/d' kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      - name: Build Kernel
        run: |
          cd kernel_workspace/
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache clang"
          ./build/build.sh
          ccache -s

      - name: Verify Kernel Build
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          if [ ! -f "$IMAGE" ]; then
            echo "ERROR: Image.gz not found!"
            exit 1
          fi
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz size: $SIZE bytes"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: Image.gz too small!"
            exit 1
          fi

      - name: Create AnyKernel3 Package
        run: |
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1 Anykernel3_Zabixii
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz Anykernel3_Zabixii/Image.gz

      - name: Set Artifact Suffix
        id: suffix
        run: |
          SUFFIX=""
          if [ "${{ github.event.inputs.KSU }}" = "true" ]; then
            SUFFIX="_KSU"
            [ "${{ github.event.inputs.VFS }}" = "true" ] && SUFFIX="${SUFFIX}_VFS"
            [ "${{ github.event.inputs.KPM }}" = "true" ] && SUFFIX="${SUFFIX}_KPM"
          else
            SUFFIX="_MAGISK"
          fi
          [ "${{ github.event.inputs.NETHUNTER }}" = "true" ] && SUFFIX="${SUFFIX}_NH"
          echo "value=${SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: "Zabixii_Kernel${{ steps.suffix.outputs.value }}_by_Zabixii"
          path: ./Anykernel3_Zabixii/*
