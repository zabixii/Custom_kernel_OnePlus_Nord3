# ============================================
# Zabixii Kernel Build Workflow
# Version: 3.0.0
# ============================================
# ROOT CAUSE FIX:
#   NEVER append to gki_defconfig.
#   Use scripts/config to modify .config AFTER
#   defconfig generation. This bypasses Kconfig
#   re-resolution and avoids the select chains
#   that force dangerous =y configs.
# ============================================

name: Build OnePlus Nord 3 AOSP - Zabixii (NetHunter)

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"
      NETHUNTER:
        type: boolean
        description: "Enable NetHunter kernel support?"
        required: true
        default: true

jobs:
  build:
    name: "[MAGISK]${{ github.event.inputs.NETHUNTER == 'true' && ' [NH]' || '' }} ${{ github.event.inputs.SUFFIX }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Build Configuration
        run: |
          echo "=============================================="
          echo "  Zabixii Kernel Build v3.0.0"
          echo "  FIX: scripts/config instead of gki_defconfig"
          echo "=============================================="
          echo "SUFFIX: ${{ github.event.inputs.SUFFIX }}"
          echo "NETHUNTER: ${{ github.event.inputs.NETHUNTER }}"
          echo "=============================================="

      - name: Set Environment Variables
        run: |
          echo "CPU=mt6983" >> $GITHUB_ENV
          echo "ANDROID_VERSION=android12" >> $GITHUB_ENV
          echo "KERNEL_VERSION=5.10" >> $GITHUB_ENV

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Configure Git
        run: |
          git config --global user.name "zabixii"
          git config --global user.email "154690973+zabixii@users.noreply.github.com"

      - name: Install Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y python3 git curl libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip llvm lld

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Copy Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          rm -rf kernel_module

      - name: Create Thermal Makefile
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile

      - name: Create Fingerprint Makefile
        run: |
          cd kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

      - name: Fix Audio Codec
        run: |
          cd kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c

      - name: Fix task_mmu
        run: |
          sed -i '/goto show_pad;/d' kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      - name: Apply Custom Suffix
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          SCRIPT="kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion"
          sed -i 's/ -dirty//g' "$SCRIPT"
          echo "" >> "$SCRIPT"
          echo "echo \"-${ANDROID_VERSION}-${SUFFIX}\"" >> "$SCRIPT"
          echo "exit 0" >> "$SCRIPT"
          chmod +x "$SCRIPT"
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX" || true

      - name: Disable check_defconfig
        run: |
          cd kernel_workspace/kernel-5.10
          sed -i 's/check_defconfig//' ./build.config.gki

      # ============================================
      # KEY FIX: Inject NetHunter configs via
      # POST_DEFCONFIG_CMDS using scripts/config
      # This modifies .config AFTER defconfig
      # without triggering Kconfig re-resolution
      # ============================================
      - name: Setup NetHunter Config Injection
        if: ${{ github.event.inputs.NETHUNTER == 'true' }}
        run: |
          cd kernel_workspace/kernel-5.10
          
          # Create a script that will be called by POST_DEFCONFIG_CMDS
          cat > nethunter_inject.sh << 'SCRIPT'
          #!/bin/bash
          # This runs AFTER defconfig, modifying .config directly
          # No Kconfig re-resolution = no dangerous select chains
          
          SCRIPTS_CONFIG="${ROOT_DIR}/${KERNEL_DIR}/scripts/config"
          CONFIG_FILE="${OUT_DIR}/.config"
          
          echo "=============================================="
          echo "  NetHunter v3.0.0 - scripts/config injection"
          echo "  Bypassing Kconfig select chains"
          echo "=============================================="
          
          # WiFi - as modules
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_CFG80211
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MAC80211
          
          # MT76 WiFi
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MT76_CORE
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MT76_USB
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MT76x02_LIB
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MT76x02_USB
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MT76x2_COMMON
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MT76x2U
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MT7601U
          
          # ATH9K WiFi
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_ATH_COMMON
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_ATH9K
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_ATH9K_HW
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_ATH9K_COMMON
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_ATH9K_HTC
          
          # RT2800 WiFi
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_RT2X00
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_RT2800_LIB
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_RT2800USB
          
          # Realtek WiFi
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_RTL8XXXU
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_RTL8187
          
          # USB HID - as modules
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_USB_CONFIGFS_F_HID
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_USB_F_HID
          
          # USB Serial - as modules
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_USB_SERIAL_CH341
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_USB_SERIAL_CP210X
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_USB_SERIAL_FTDI_SIO
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_USB_SERIAL_PL2303
          
          # Networking - as modules
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_TUN
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_VETH
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_BRIDGE
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_VLAN_8021Q
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_MACVLAN
          
          # Bluetooth - as modules
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_BT_RFCOMM
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_BT_BNEP
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_BT_HIDP
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_BT_HCIBTUSB
          
          # PPP/VPN - as modules
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_PPP
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_PPP_DEFLATE
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_PPP_MPPE
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_PPTP
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_PPPOE
          
          # Filesystems - as modules
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_OVERLAY_FS
          ${SCRIPTS_CONFIG} --file ${CONFIG_FILE} --module CONFIG_SQUASHFS
          
          echo "NetHunter configs injected via scripts/config"
          echo "=============================================="
          SCRIPT
          
          chmod +x nethunter_inject.sh
          
          # Modify build.config.oplus6983 to call our script
          # Add to POST_DEFCONFIG_CMDS
          if grep -q "POST_DEFCONFIG_CMDS" build.config.oplus6983; then
            # Append to existing POST_DEFCONFIG_CMDS
            sed -i 's|POST_DEFCONFIG_CMDS="\(.*\)"|POST_DEFCONFIG_CMDS="\1 \&\& ${KERNEL_DIR}/nethunter_inject.sh"|' build.config.oplus6983
          else
            # Add new POST_DEFCONFIG_CMDS
            echo 'POST_DEFCONFIG_CMDS="${KERNEL_DIR}/nethunter_inject.sh"' >> build.config.oplus6983
          fi
          
          echo "POST_DEFCONFIG_CMDS configured to inject NetHunter configs"
          cat build.config.oplus6983

      - name: Clean and Build
        run: |
          cd kernel_workspace/
          rm -rf out/
          ./build/build.sh 2>&1 | tee /tmp/build.log

      - name: Verify No Dangerous Configs
        if: always()
        run: |
          FINAL_CONFIG=$(find kernel_workspace/out/ -name ".config" -type f 2>/dev/null | head -1)
          if [ -n "$FINAL_CONFIG" ]; then
            echo "=== Checking for KMI-breaking configs ==="
            echo ""
            echo "--- Namespaces (must NOT be =y if not in stock) ---"
            grep -E "CONFIG_(NET_NS|PID_NS|IPC_NS|UTS_NS|USER_NS)=" "$FINAL_CONFIG" || echo "None found"
            echo ""
            echo "--- WEXT (must NOT be =y) ---"
            grep -E "CONFIG_(WIRELESS_EXT|WEXT_CORE|WEXT_PROC|WEXT_PRIV|WEXT_SPY|CFG80211_WEXT)=" "$FINAL_CONFIG" || echo "None found"
            echo ""
            echo "--- Our NetHunter configs (should be =m) ---"
            grep -E "CONFIG_(CFG80211|MAC80211|USB_F_HID|OVERLAY_FS|TUN|BRIDGE)=" "$FINAL_CONFIG" || echo "None found"
          fi

      - name: Verify Kernel Build
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          if [ ! -f "$IMAGE" ]; then
            echo "ERROR: Image.gz not found!"
            exit 1
          fi
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: Image.gz too small!"
            exit 1
          fi
          echo "Build OK"

      - name: Package
        run: |
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1 Anykernel3_Zabixii
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz Anykernel3_Zabixii/Image.gz

      - name: Set Artifact Suffix
        id: suffix
        run: |
          SUFFIX="_MAGISK"
          if [ "${{ github.event.inputs.NETHUNTER }}" = "true" ]; then
            SUFFIX="${SUFFIX}_NH"
          fi
          echo "value=${SUFFIX}" >> $GITHUB_OUTPUT

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: "Zabixii_Kernel${{ steps.suffix.outputs.value }}_by_Zabixii"
          path: ./Anykernel3_Zabixii/*

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "Build_Log"
          path: /tmp/build.log
