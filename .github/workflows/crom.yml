# ============================================
# Zabixii Kernel DIAGNOSTIC Workflow
# Version: DIAG-2.0
# ============================================
# CONFIRMED:
#   Level 1: ✅ BOOTS
#   Level 2: ✅ BOOTS
#   Level 3: ❌ BOOTLOOP (NetHunter =m configs)
#
# This workflow splits Level 3 into 6 sub-groups
# to find the EXACT config(s) causing bootloop.
# Run 3A first. If it boots, run 3B, etc.
# When one bootloops, that group is the culprit.
# ============================================

name: DIAGNOSTIC - NetHunter Bisect

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      DIAG_LEVEL:
        type: choice
        description: "Which group to test?"
        required: true
        default: "3A"
        options:
          - "3A"
          - "3B"
          - "3C"
          - "3D"
          - "3E"
          - "3F"
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"

jobs:
  diagnose:
    name: "DIAG ${{ github.event.inputs.DIAG_LEVEL }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Diagnostic Plan
        run: |
          echo "=============================================="
          echo "  NETHUNTER BISECT - Group ${{ github.event.inputs.DIAG_LEVEL }}"
          echo "=============================================="
          echo ""
          echo "3A: WiFi (CFG80211, MAC80211, MT76, ATH9K, RT2800, RTL)"
          echo "3B: USB (HID, Serial adapters)"
          echo "3C: Networking (TUN, VETH, BRIDGE, VLAN, MACVLAN)"
          echo "3D: Bluetooth (RFCOMM, BNEP, HIDP, HCIBTUSB)"
          echo "3E: PPP/VPN (PPP, DEFLATE, MPPE, PPTP, PPPOE)"
          echo "3F: Filesystems (OVERLAY_FS, SQUASHFS)"
          echo ""
          echo ">>> TESTING GROUP ${{ github.event.inputs.DIAG_LEVEL }} <<<"
          echo "=============================================="

      - name: Set Environment Variables
        run: |
          echo "CPU=mt6983" >> $GITHUB_ENV
          echo "ANDROID_VERSION=android12" >> $GITHUB_ENV
          echo "KERNEL_VERSION=5.10" >> $GITHUB_ENV
          echo "BUILD_METHOD=perf" >> $GITHUB_ENV

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Configure Git
        run: |
          git config --global user.name "zabixii"
          git config --global user.email "154690973+zabixii@users.noreply.github.com"

      - name: Install Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y python3 git curl libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip llvm lld

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Copy Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          rm -rf kernel_module

      - name: "[DIAG] Save stock defconfig"
        run: |
          cp kernel_workspace/kernel-5.10/arch/arm64/configs/gki_defconfig /tmp/gki_defconfig.stock

      # ============================================
      # LEVEL 1: Vendor fixes (confirmed safe)
      # ============================================
      - name: Vendor Fixes
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile

          cd $GITHUB_WORKSPACE/kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

          cd $GITHUB_WORKSPACE/kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c

          sed -i '/goto show_pad;/d' $GITHUB_WORKSPACE/kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      # ============================================
      # LEVEL 2: Suffix + check_defconfig (confirmed safe)
      # ============================================
      - name: Apply Suffix and Disable check_defconfig
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          SCRIPT="kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion"
          sed -i 's/ -dirty//g' "$SCRIPT"
          echo "" >> "$SCRIPT"
          echo "echo \"-${ANDROID_VERSION}-${SUFFIX}\"" >> "$SCRIPT"
          echo "exit 0" >> "$SCRIPT"
          chmod +x "$SCRIPT"
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX" || true
          sed -i 's/check_defconfig//' ./build.config.gki

      # ============================================
      # LEVEL 3 GROUPS: One at a time
      # ============================================
      - name: "Add Group 3A - WiFi"
        if: ${{ github.event.inputs.DIAG_LEVEL == '3A' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'

          # GROUP 3A: WiFi
          CONFIG_CFG80211=m
          CONFIG_MAC80211=m
          CONFIG_MAC80211_MESH=y
          CONFIG_MT76_CORE=m
          CONFIG_MT76_USB=m
          CONFIG_MT76x02_LIB=m
          CONFIG_MT76x02_USB=m
          CONFIG_MT76x2_COMMON=m
          CONFIG_MT76x2U=m
          CONFIG_MT7601U=m
          CONFIG_ATH_COMMON=m
          CONFIG_ATH9K=m
          CONFIG_ATH9K_HW=m
          CONFIG_ATH9K_COMMON=m
          CONFIG_ATH9K_HTC=m
          CONFIG_RT2X00=m
          CONFIG_RT2800_LIB=m
          CONFIG_RT2800USB=m
          CONFIG_RTL8XXXU=m
          CONFIG_RTL8187=m
          EOF
          echo "Group 3A added"

      - name: "Add Group 3B - USB"
        if: ${{ github.event.inputs.DIAG_LEVEL == '3B' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'

          # GROUP 3B: USB
          CONFIG_USB_CONFIGFS_F_HID=m
          CONFIG_USB_F_HID=m
          CONFIG_USB_SERIAL_CH341=m
          CONFIG_USB_SERIAL_CP210X=m
          CONFIG_USB_SERIAL_FTDI_SIO=m
          CONFIG_USB_SERIAL_PL2303=m
          EOF
          echo "Group 3B added"

      - name: "Add Group 3C - Networking"
        if: ${{ github.event.inputs.DIAG_LEVEL == '3C' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'

          # GROUP 3C: Networking
          CONFIG_TUN=m
          CONFIG_VETH=m
          CONFIG_BRIDGE=m
          CONFIG_VLAN_8021Q=m
          CONFIG_MACVLAN=m
          EOF
          echo "Group 3C added"

      - name: "Add Group 3D - Bluetooth"
        if: ${{ github.event.inputs.DIAG_LEVEL == '3D' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'

          # GROUP 3D: Bluetooth
          CONFIG_BT_RFCOMM=m
          CONFIG_BT_BNEP=m
          CONFIG_BT_HIDP=m
          CONFIG_BT_HCIBTUSB=m
          EOF
          echo "Group 3D added"

      - name: "Add Group 3E - PPP/VPN"
        if: ${{ github.event.inputs.DIAG_LEVEL == '3E' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'

          # GROUP 3E: PPP/VPN
          CONFIG_PPP=m
          CONFIG_PPP_DEFLATE=m
          CONFIG_PPP_MPPE=m
          CONFIG_PPTP=m
          CONFIG_PPPOE=m
          EOF
          echo "Group 3E added"

      - name: "Add Group 3F - Filesystems"
        if: ${{ github.event.inputs.DIAG_LEVEL == '3F' }}
        run: |
          cd kernel_workspace/kernel-5.10
          cat >> arch/arm64/configs/gki_defconfig << 'EOF'

          # GROUP 3F: Filesystems
          CONFIG_OVERLAY_FS=m
          CONFIG_SQUASHFS=m
          CONFIG_SQUASHFS_XZ=y
          CONFIG_SQUASHFS_LZO=y
          EOF
          echo "Group 3F added"

      # ============================================
      # DIAGNOSTIC: Find hidden =y selects
      # ============================================
      - name: "[DIAG] Defconfig diff"
        run: |
          diff /tmp/gki_defconfig.stock kernel_workspace/kernel-5.10/arch/arm64/configs/gki_defconfig > /tmp/defconfig.diff || true
          echo "=== What we added ==="
          grep '^>' /tmp/defconfig.diff

      - name: Clean and Build
        run: |
          cd kernel_workspace/
          rm -rf out/
          ./build/build.sh 2>&1 | tee /tmp/build.log

      - name: "[DIAG] Find hidden =y selects (THE SMOKING GUN)"
        if: always()
        run: |
          FINAL_CONFIG=$(find kernel_workspace/out/ -name ".config" -type f 2>/dev/null | head -1)
          if [ -n "$FINAL_CONFIG" ]; then
            cp "$FINAL_CONFIG" /tmp/final_config.txt

            echo "=============================================="
            echo "  NEW =y CONFIGS vs STOCK"
            echo "  (configs forced to built-in by Kconfig select)"
            echo "=============================================="
            comm -13 <(grep "=y" /tmp/gki_defconfig.stock | sort) <(grep "=y" /tmp/final_config.txt | sort) > /tmp/new_builtins.txt
            echo ""
            echo "COUNT: $(wc -l < /tmp/new_builtins.txt)"
            echo ""
            cat /tmp/new_builtins.txt
            echo ""
            echo "=============================================="
            echo "^^^ THESE are the configs that Group ${{ github.event.inputs.DIAG_LEVEL }}"
            echo "    silently forced to =y via Kconfig 'select'."
            echo "    If ANY modify core structs, that's the bootloop."
            echo "=============================================="
            echo ""
            
            echo "=== Checking specific dangerous configs ==="
            echo "--- Namespaces (task_struct) ---"
            grep -E "CONFIG_(NET_NS|PID_NS|IPC_NS|UTS_NS|USER_NS)=y" /tmp/final_config.txt && echo "!!! FOUND - BOOTLOOP CAUSE !!!" || echo "  Clean"
            echo "--- WEXT (net_device) ---"
            grep -E "CONFIG_(WIRELESS_EXT|WEXT_CORE|WEXT_PROC|WEXT_PRIV|WEXT_SPY|CFG80211_WEXT)=y" /tmp/final_config.txt && echo "!!! FOUND - BOOTLOOP CAUSE !!!" || echo "  Clean"
            echo "--- Overlay (struct inode) ---"
            grep "CONFIG_OVERLAY_FS=y" /tmp/final_config.txt && echo "!!! FOUND - BOOTLOOP CAUSE !!!" || echo "  Clean"
            echo "--- TCP (tcp_sock) ---"
            grep "CONFIG_TCP_CONG_BBR=y" /tmp/final_config.txt && echo "!!! FOUND - BOOTLOOP CAUSE !!!" || echo "  Clean"
            echo "--- NF_CONNTRACK (nf_conn struct) ---"
            grep "CONFIG_NF_CONNTRACK=y" /tmp/final_config.txt && echo "  Present (check if new)" || echo "  Not present"
            echo "--- BRIDGE_NETFILTER (sk_buff) ---"
            grep "CONFIG_BRIDGE_NETFILTER=y" /tmp/final_config.txt && echo "  Present (check if new)" || echo "  Not present"
            echo "--- NETFILTER_NETLINK (adds to core) ---"
            grep "CONFIG_NETFILTER_NETLINK=y" /tmp/final_config.txt && echo "  Present (check if new)" || echo "  Not present"
          else
            echo "ERROR: No .config found"
          fi

      - name: Verify Kernel Build
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          if [ ! -f "$IMAGE" ]; then
            echo "ERROR: Image.gz not found!"
            exit 1
          fi
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: Image.gz too small!"
            exit 1
          fi
          echo "Build OK"

      - name: Package and Upload
        run: |
          git clone https://github.com/darklord4567/Anykernel3_AOSP_NORD3.git --depth=1 Anykernel3_Zabixii
          cp kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz Anykernel3_Zabixii/Image.gz

      - name: Upload Kernel
        uses: actions/upload-artifact@v4
        with:
          name: "DIAG_${{ github.event.inputs.DIAG_LEVEL }}_Kernel"
          path: ./Anykernel3_Zabixii/*

      - name: Upload Diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "DIAG_${{ github.event.inputs.DIAG_LEVEL }}_Config"
          path: |
            /tmp/final_config.txt
            /tmp/gki_defconfig.stock
            /tmp/defconfig.diff
            /tmp/new_builtins.txt
            /tmp/build.log

      - name: "[DIAG] Instructions"
        if: always()
        run: |
          echo "=============================================="
          echo "  Group ${{ github.event.inputs.DIAG_LEVEL }} built."
          echo "=============================================="
          echo ""
          echo "1. Flash and test boot."
          echo ""
          echo "2. ALSO: Download DIAG_Config artifact NOW."
          echo "   Even before flashing, open new_builtins.txt."
          echo "   Those are configs your =m selections secretly"
          echo "   forced to =y. Share that file."
          echo ""
          echo "3. Results matrix:"
          echo "   3A boots → test 3B"
          echo "   3A bootloops → WiFi configs are the problem"
          echo "     (likely CFG80211=m selecting WIRELESS_EXT=y)"
          echo "   3B boots → test 3C"
          echo "   3C bootloops → BRIDGE=m selecting BRIDGE_NETFILTER=y"
          echo "     (modifies sk_buff struct)"
          echo "   3F bootloops → SQUASHFS_XZ=y or SQUASHFS_LZO=y"
          echo "     (bool sub-options forcing parent changes)"
          echo ""
          echo "4. When you find the broken group, share"
          echo "   new_builtins.txt and we split it further."
          echo "=============================================="
