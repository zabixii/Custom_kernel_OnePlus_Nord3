# ============================================
# Zabixii - Capture Booting Config
# Version: CAPTURE-1.0
# ============================================
# Builds Level 2 (confirmed boots) and uploads
# the final .config for manual editing
# ============================================

name: CAPTURE - Booting Config

on:
  workflow_dispatch:
    inputs:
      FILE:
        type: string
        description: "Configuration file"
        required: true
        default: manifest_aosp
      SUFFIX:
        type: string
        description: "Custom kernel suffix"
        required: false
        default: "Zabixii"

jobs:
  capture:
    name: "Capture booting .config"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Environment Variables
        run: |
          echo "CPU=mt6983" >> $GITHUB_ENV
          echo "ANDROID_VERSION=android12" >> $GITHUB_ENV
          echo "KERNEL_VERSION=5.10" >> $GITHUB_ENV

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Create Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile

      - name: Configure Git
        run: |
          git config --global user.name "zabixii"
          git config --global user.email "154690973+zabixii@users.noreply.github.com"

      - name: Install Dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y python3 git curl libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip llvm lld

      - name: Install Repo Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo

      - name: Initialize Repo and Sync
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          repo init -u https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git -m ${{ github.event.inputs.FILE }}.xml --depth=1
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync

      - name: Copy Build Configuration
        run: |
          git clone https://github.com/hemasai1109/Custom_kernel_OnePlus_Nord3.git kernel_workflow
          cp kernel_workflow/build.config.oplus6983-d kernel_workspace/kernel-5.10/
          cd kernel_workspace/kernel-5.10
          mv build.config.oplus6983-d build.config.oplus6983

      - name: Set Build Config Path
        run: echo "BUILD_CONFIG=kernel-5.10/build.config.oplus6983" >> $GITHUB_ENV

      - name: Fix Vendor Directory
        run: |
          cd kernel_workspace
          mv kernel_module/vendor .
          rm -rf kernel_module

      - name: Create Thermal Makefile
        run: |
          cd kernel_workspace/vendor/oplus/kernel/cpu/thermal
          echo "obj-y += horae_shell_temp" > Makefile
          echo "obj-y += oplus_ipa_thermal" >> Makefile

      - name: Create Fingerprint Makefile
        run: |
          cd kernel_workspace/vendor/oplus/secure/biometrics/fingerprints/bsp/drivers_kernel/component3.0/mtk
          cat > Makefile << 'EOF'
          obj-$(CONFIG_OPLUS_FINGERPRINT_COMMON) += oplus_fp_common/
          ifneq ($(CONFIG_OPLUS_FINGERPRINT_GOODIX)_$(CONFIG_OPLUS_FINGERPRINT_GOODIX_OPTICAL), _)
          obj-y += goodix_optical_fp/
          endif
          obj-$(CONFIG_OPLUS_FINGERPRINT_JIIOV_OPTICAL) += anc_driver/
          obj-$(CONFIG_OPLUS_FINGERPRINT_SILEAD_CAP) += silead/
          ccflags-$(CONFIG_OPLUS_FINGERPRINT_NAVIGATION_ENABLE) += -DFP_NAVIGATION_ENABLE
          EOF

      - name: Fix Audio Codec
        run: |
          cd kernel_workspace/kernel-5.10/sound/soc/codecs/
          sed -i 's/^int accdet_read_audio_res(unsigned int res_value)/int mt6357_accdet_read_audio_res(unsigned int res_value)/' mt6357-accdet.c
          sed -i 's/^EXPORT_SYMBOL(accdet_read_audio_res);/EXPORT_SYMBOL(mt6357_accdet_read_audio_res);/' mt6357-accdet.c

      - name: Fix task_mmu
        run: |
          sed -i '/goto show_pad;/d' kernel_workspace/kernel-5.10/fs/proc/task_mmu.c

      - name: Apply Custom Suffix
        run: |
          cd kernel_workspace
          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID_VERSION="${{ env.ANDROID_VERSION }}"
          SCRIPT="kernel-${{ env.KERNEL_VERSION }}/scripts/setlocalversion"
          sed -i 's/ -dirty//g' "$SCRIPT"
          echo "" >> "$SCRIPT"
          echo "echo \"-${ANDROID_VERSION}-${SUFFIX}\"" >> "$SCRIPT"
          echo "exit 0" >> "$SCRIPT"
          chmod +x "$SCRIPT"
          cd kernel-${{ env.KERNEL_VERSION }}
          git add -A
          git commit -m "Custom suffix: $SUFFIX" || true

      - name: Disable check_defconfig
        run: |
          cd kernel_workspace/kernel-5.10
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Clean and Build
        run: |
          cd kernel_workspace/
          rm -rf out/
          ./build/build.sh 2>&1 | tee /tmp/build.log

      - name: Capture All Config Files
        if: always()
        run: |
          mkdir -p /tmp/captured_configs
          
          # Find and copy the final .config
          find kernel_workspace/out/ -name ".config" -type f | while read f; do
            DIR=$(echo "$f" | sed 's|kernel_workspace/out/||' | sed 's|/\.config||' | tr '/' '_')
            cp "$f" "/tmp/captured_configs/config_${DIR}.txt"
            echo "Captured: $f -> config_${DIR}.txt"
          done
          
          # Copy the stock gki_defconfig for reference
          cp kernel_workspace/kernel-5.10/arch/arm64/configs/gki_defconfig /tmp/captured_configs/stock_gki_defconfig.txt
          
          # Copy build.config files
          cp kernel_workspace/kernel-5.10/build.config.oplus6983 /tmp/captured_configs/build_config_oplus6983.txt
          cp kernel_workspace/kernel-5.10/build.config.gki /tmp/captured_configs/build_config_gki.txt 2>/dev/null || true
          
          echo ""
          echo "=== All captured configs ==="
          ls -la /tmp/captured_configs/

      - name: Analyze Config for NetHunter Readiness
        if: always()
        run: |
          CONFIG=$(find /tmp/captured_configs/ -name "config_*.txt" | head -1)
          if [ -z "$CONFIG" ]; then
            echo "No config found!"
            exit 0
          fi
          
          echo "=============================================="
          echo "  BOOTING CONFIG ANALYSIS"
          echo "  File: $CONFIG"
          echo "  Lines: $(wc -l < "$CONFIG")"
          echo "=============================================="
          echo ""
          
          echo "=== Current NetHunter-relevant configs ==="
          echo ""
          echo "--- WiFi framework ---"
          grep -E "CONFIG_(CFG80211|MAC80211|WIRELESS|WEXT|RFKILL)=" "$CONFIG" | sort || echo "  None"
          echo ""
          echo "--- USB ---"
          grep -E "CONFIG_USB_(F_HID|CONFIGFS_F_HID|SERIAL)=" "$CONFIG" | sort || echo "  None"
          echo ""
          echo "--- Networking ---"
          grep -E "CONFIG_(TUN|VETH|BRIDGE|VLAN_8021Q|MACVLAN)=" "$CONFIG" | sort || echo "  None"
          echo ""
          echo "--- Bluetooth ---"
          grep -E "CONFIG_BT_(RFCOMM|BNEP|HIDP|HCIBTUSB)=" "$CONFIG" | sort || echo "  None"
          echo ""
          echo "--- PPP ---"
          grep -E "CONFIG_(PPP|PPTP|PPPOE)=" "$CONFIG" | sort || echo "  None"
          echo ""
          echo "--- Filesystems ---"
          grep -E "CONFIG_(OVERLAY_FS|SQUASHFS)=" "$CONFIG" | sort || echo "  None"
          echo ""
          echo "--- Namespaces ---"
          grep -E "CONFIG_(NET_NS|PID_NS|IPC_NS|UTS_NS|USER_NS|TIME_NS)=" "$CONFIG" | sort || echo "  None"
          echo ""
          echo "=============================================="
          echo "  NEXT STEP:"
          echo "  1. Download captured_configs artifact"
          echo "  2. Open the config_*.txt file"
          echo "  3. Add NetHunter =m lines manually"
          echo "  4. Commit to your repo as custom defconfig"
          echo "  5. Build using that defconfig directly"
          echo "=============================================="

      - name: Verify Kernel Build
        run: |
          IMAGE="kernel_workspace/out/android12-5.10/kernel-5.10/arch/arm64/boot/Image.gz"
          if [ ! -f "$IMAGE" ]; then
            echo "ERROR: Image.gz not found!"
            exit 1
          fi
          SIZE=$(stat -c%s "$IMAGE")
          echo "Image.gz: $SIZE bytes ($(($SIZE / 1024 / 1024)) MB)"
          echo "Build OK"

      - name: Upload Captured Configs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "Captured_Booting_Configs"
          path: /tmp/captured_configs/*

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "Build_Log"
          path: /tmp/build.log
